<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LaamSocial - Social Network</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
    <style>
        :root {
            --primary: #6c63ff;
            --primary-dark: #5a52d5;
            --secondary: #ff6584;
            --dark: #2d3748;
            --light: #f8f9fa;
            --gray: #a0aec0;
            --success: #48bb78;
            --warning: #ed8936;
            --danger: #f56565;
            --sidebar-width: 250px;
            --header-height: 70px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fb;
            color: var(--dark);
            line-height: 1.6;
        }
  /* Header Styles */
        header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            height: var(--header-height);
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }

        header h2 {
            font-weight: 700;
            font-size: 1.8rem;
            letter-spacing: 1px;
}
 
        .header-nav {
            display: flex;
            gap: 1.5rem;
        }

        .header-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .header-nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .header-nav-item.active {
            background: rgba(255, 255, 255, 0.2);
        }

        .header-nav-item i {
            font-size: 1.2rem;
            margin-bottom: 0.3rem;
        }

        .header-nav-item span {
            font-size: 0.8rem;
            font-weight: 500;
        }

        /* Main Container */
        .container-dashboard {
            display: flex;
            margin-top: var(--header-height);
            min-height: calc(100vh - var(--header-height));
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background: white;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.05);
            padding: 1.5rem 0;
            position: fixed;
            height: calc(100vh - var(--header-height));
            overflow-y: auto;
            transition: all 0.3s ease;
        }

        .sidebar ul {
            list-style: none;
        }

        .sidebar li {
            padding: 1rem 2rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }

        .sidebar li:hover {
            background: rgba(108, 99, 255, 0.1);
            color: var(--primary);
        }

        .sidebar li.active {
            background: rgba(108, 99, 255, 0.15);
            color: var(--primary);
            border-left: 4px solid var(--primary);
            font-weight: 600;
        }

        .sidebar li i {
            margin-right: 10px;
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 2rem;
            transition: all 0.3s ease;
        }

        section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
            display: none;
        }

        section.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h3 {
            color: var(--primary);
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #f0f0f0;
            font-size: 1.5rem;
        }
#newTokenAddress {
  transition: border-color 0.3s;
}
#tokenStatusIcon {
  transition: color 0.3s ease;
}
        /* Post Section */
        #postSection {
            background: #f8f9ff;
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 2rem;
        }

        #postText {
            width: 100%;
            min-height: 100px;
            padding: 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            margin-bottom: 1rem;
            resize: vertical;
            font-size: 1rem;
            transition: border 0.3s ease;
        }

        #postText:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(108, 99, 255, 0.2);
        }

        .file-upload-container {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }

        .file-upload-label {
            background: var(--light);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            border: 1px dashed var(--gray);
        }

        .file-upload-label:hover {
            background: #e9ecef;
        }

        #postImage {
            display: none;
        }

        #postBtn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: block;
            width: 100%;
        }

        #postBtn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(108, 99, 255, 0.3);
        }


        /* Feed */
        .post {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border: 1px solid #f0f0f0;
        }

        .post-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }

        .post-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 1rem;
        }

        .post-user-info {
            flex: 1;
        }

        .post-user {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .post-username {
            color: var(--gray);
            font-size: 0.9rem;
        }

        .post-time {
            color: var(--gray);
            font-size: 0.85rem;
        }

        .post-content {
            margin-bottom: 1rem;
        }

        .post-image {
            width: 100%;
            border-radius: 8px;
            margin-top: 1rem;
            max-height: 400px;
            object-fit: cover;
        }

        .post-actions {
            display: flex;
            gap: 1rem;
            border-top: 1px solid #f0f0f0;
            padding-top: 1rem;
        }

        .post-action {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            color: var(--gray);
            transition: all 0.3s ease;
        }

        .post-action:hover {
            color: var(--primary);
        }
.spinner {
  display: inline-block;
  width: 16px;
  height: 16px;
  border: 2px solid #ccc;
  border-top: 2px solid #4CAF50;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin-right: 6px;
  vertical-align: middle;
}

.hidden {
  display: none;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

        /* Friends Section */
        .friends-tabs {
            display: flex;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .friends-tab {
            padding: 0.8rem 1.5rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .friends-tab.active {
            border-bottom: 2px solid var(--primary);
            color: var(--primary);
            font-weight: 600;
        }

        .friends-tab:hover {
            background: #f8f9fa;
        }

        .friends-content {
            display: none;
        }

        .friends-content.active {
            display: block;
        }

        .search-container {
            margin-bottom: 1.5rem;
        }

        .search-input {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(108, 99, 255, 0.2);
        }

        .friends-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1.5rem;
        }

        .friend-card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            text-align: center;
            border: 1px solid #f0f0f0;
        }

        .friend-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .friend-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.5rem;
            margin: 1.5rem auto 1rem;
        }

        .friend-name {
            font-weight: 600;
            margin-bottom: 0.3rem;
        }

        .friend-username {
            color: var(--gray);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .friend-status {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-bottom: 1rem;
        }

        .online {
            background: rgba(72, 187, 120, 0.2);
            color: var(--success);
        }

        .offline {
            background: rgba(160, 174, 192, 0.2);
            color: var(--gray);
        }

        .friend-actions {
            display: flex;
            border-top: 1px solid #f0f0f0;
        }

        .friend-action {
            flex: 1;
            padding: 0.8rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .friend-action:hover {
            background: #f8f9fa;
        }

        .friend-action.message {
            color: var(--primary);
        }

        .friend-action.add {
            color: var(--success);
        }

        .friend-action.remove {
            color: var(--danger);
        }

        .friend-action.confirm {
            color: var(--success);
        }

        .friend-action.reject {
            color: var(--danger);
        }

        /* Friend Requests */
        .requests-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .request-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            background: #f8f9ff;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
        }

        .request-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 1rem;
        }

        .request-info {
            flex: 1;
        }

        .request-name {
            font-weight: 600;
            margin-bottom: 0.2rem;
        }

        .request-username {
            color: var(--gray);
            font-size: 0.9rem;
        }

        .request-actions {
            display: flex;
            gap: 0.5rem;
        }

        .request-action {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .request-action.confirm {
            background: var(--success);
            color: white;
            border: none;
        }

        .request-action.reject {
            background: var(--danger);
            color: white;
            border: none;
        }

        .request-action.confirm:hover {
            background: #38a169;
        }

        .request-action.reject:hover {
            background: #e53e3e;
        }

        /* Messages Section */
        .messages-container {
            display: flex;
            gap: 1.5rem;
            height: 500px;
        }

        .conversations-list {
            width: 300px;
            background: #f8f9ff;
            border-radius: 10px;
            padding: 1rem;
            overflow-y: auto;
        }

        .conversation {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 0.5rem;
        }

        .conversation:hover {
            background: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .conversation.active {
            background: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .conversation-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 1rem;
        }

        .conversation-info {
            flex: 1;
        }

        .conversation-name {
            font-weight: 600;
            margin-bottom: 0.2rem;
        }

        .conversation-preview {
            color: var(--gray);
            font-size: 0.85rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 180px;
        }

        .conversation-time {
            font-size: 0.75rem;
            color: var(--gray);
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .chat-header {
            padding: 1rem 1.5rem;
            background: #f8f9ff;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
        }
/* Friends Selection Styles */
.friends-selection {
    padding: 2rem;
    text-align: center;
    flex: 1;
    display: flex;
    flex-direction: column;
}

.selection-header {
    margin-bottom: 2rem;
}

.selection-header h4 {
    color: var(--primary);
    margin-bottom: 0.5rem;
    font-size: 1.5rem;
}

.selection-header p {
    color: var(--gray);
    font-size: 1rem;
}

.friends-selection-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 1rem;
    max-height: 400px;
    overflow-y: auto;
    padding: 1rem;
}

.friend-selection-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid transparent;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.friend-selection-card:hover {
    transform: translateY(-5px);
    border-color: var(--primary);
    box-shadow: 0 5px 15px rgba(108, 99, 255, 0.2);
}

.friend-selection-card:active {
    transform: translateY(-2px);
}

.friend-selection-avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 1.2rem;
    margin: 0 auto 1rem auto;
}

.friend-selection-name {
    font-weight: 600;
    margin-bottom: 0.3rem;
    color: var(--dark);
}

.friend-selection-username {
    color: var(--gray);
    font-size: 0.85rem;
    margin-bottom: 0.5rem;
}

.friend-selection-status {
    display: inline-block;
    padding: 0.2rem 0.8rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
}

.friend-selection-status.online {
    background: rgba(72, 187, 120, 0.1);
    color: var(--success);
}

.friend-selection-status.offline {
    background: rgba(160, 174, 192, 0.1);
    color: var(--gray);
}

/* No friends state */
.no-friends-message {
    grid-column: 1 / -1;
    padding: 3rem 2rem;
    text-align: center;
    color: var(--gray);
}

.no-friends-message i {
    font-size: 3rem;
    margin-bottom: 1rem;
    color: var(--primary);
    opacity: 0.5;
}

.no-friends-message h5 {
    margin-bottom: 0.5rem;
    color: var(--dark);
}

.no-friends-message p {
    margin-bottom: 1.5rem;
}

.btn-outline {
    background: transparent;
    border: 2px solid var(--primary);
    color: var(--primary);
    padding: 0.7rem 1.5rem;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-outline:hover {
    background: var(--primary);
    color: white;
}

/* Responsive design */
@media (max-width: 768px) {
    .friends-selection-list {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 0.8rem;
    }
    
    .friend-selection-card {
        padding: 1rem 0.5rem;
    }
    
    .friend-selection-avatar {
        width: 50px;
        height: 50px;
        font-size: 1rem;
    }
}
        .chat-user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 1rem;
        }

        .chat-user-info {
            flex: 1;
        }

        .chat-user-name {
            font-weight: 600;
        }

        .chat-user-status {
            font-size: 0.8rem;
            color: var(--success);
        }

        .chat-actions {
            display: flex;
            gap: 1rem;
        }

        .chat-action {
            color: var(--gray);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chat-action:hover {
            color: var(--primary);
        }

        .chat-messages {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message {
            max-width: 70%;
            padding: 0.8rem 1rem;
            border-radius: 18px;
            position: relative;
            animation: fadeIn 0.3s ease;
        }

        .message.sent {
            align-self: flex-end;
            background: var(--primary);
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message.received {
            align-self: flex-start;
            background: #f1f3f9;
            color: var(--dark);
            border-bottom-left-radius: 5px;
        }

        .message-time {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-top: 0.3rem;
            text-align: right;
        }

        .chat-input-area {
            display: flex;
            padding: 1rem 1.5rem;
            border-top: 1px solid #e2e8f0;
            gap: 1rem;
        }

        #chatInput {
            flex: 1;
            padding: 0.8rem 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 24px;
            outline: none;
            transition: all 0.3s ease;
        }

        #chatInput:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(108, 99, 255, 0.2);
        }

        #sendBtn {
            background: var(--primary);
            color: white;
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        #sendBtn:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }
/* NEW: Chat Image Upload Styles */
        .chat-input-actions {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        #attachImageBtn {
            background: none;
            border: none;
            color: #6c63ff;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 5px 10px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        #attachImageBtn:hover {
            background: rgba(108, 99, 255, 0.1);
            color: #5a52d5;
        }

        #chatImageInput {
            display: none;
        }

        .message-image {
            margin-top: 5px;
        }

        .message-image img {
            max-width: 300px;
            max-height: 300px;
            border-radius: 8px;
            object-fit: cover;
            border: 1px solid #e2e8f0;
        }

        .chat-image-preview {
            position: relative;
            margin-bottom: 10px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
            max-width: 200px;
        }

        .chat-image-preview img {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
        }

        .remove-chat-image {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }

        .chat-upload-progress {
            width: 100%;
            height: 4px;
            background-color: #e2e8f0;
            border-radius: 2px;
            margin: 5px 0;
            overflow: hidden;
            display: none;
        }
        
        .chat-upload-progress-bar {
            height: 100%;
            background-color: var(--primary);
            width: 0%;
            transition: width 0.3s ease;
        }
/*ADD THESE STYLES TO YOUR EXISTING CSS */
.message-image img {
    max-width: 300px;
    max-height: 300px;
    border-radius: 8px;
    object-fit: cover;
    border: 1px solid #e2e8f0;
    transition: transform 0.2s ease;
    display: block;
}

.message-image img:hover {
    transform: scale(1.02);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.message-text {
    word-wrap: break-word;
    line-height: 1.4;
}

.chat-upload-progress {
    width: calc(100% - 100px);
    height: 4px;
    background-color: #e2e8f0;
    border-radius: 2px;
    margin: 5px 20px;
    overflow: hidden;
    display: none;
}

.chat-upload-progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #6c63ff, #5a52d5);
    width: 0%;
    transition: width 0.3s ease;
}

/* Loading state for send button */
#sendBtn:disabled {
    background-color: #a0aec0;
    cursor: not-allowed;
}

#sendBtn .fa-spinner {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.chat-image-preview {
    position: relative;
    margin: 0 20px 10px 20px;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid #e2e8f0;
    max-width: 200px;
}

.chat-image-preview img {
    width: 100%;
    max-height: 200px;
    object-fit: cover;
}

.remove-chat-image {
    position: absolute;
    top: 5px;
    right: 5px;
    background: rgba(0,0,0,0.7);
    color: white;
    border: none;
    border-radius: 50%;
    width: 25px;
    height: 25px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
}
        /* Notifications Section */
        .notification {
            display: flex;
            align-items: flex-start;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            background: #f8f9ff;
            border-left: 4px solid var(--primary);
        }

        .notification.unread {
            background: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .notification-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            margin-right: 1rem;
            flex-shrink: 0;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 0.3rem;
        }

        .notification-time {
            font-size: 0.8rem;
            color: var(--gray);
        }

        /* Profile Section */
        .profile-header {
            display: flex;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #f0f0f0;
        }

           .profile-avatar-container {
            position: relative;
            margin-right: 2rem;
        }

        #profilePicDisplay {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .profile-avatar-overlay {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: var(--primary);
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .profile-avatar-overlay:hover {
            background: var(--primary-dark);
            transform: scale(1.1);
        }

        .profile-info h4 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .profile-stats {
            display: flex;
            gap: 2rem;
            margin-top: 1rem;
        }

        .profile-stat {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--gray);
        }

        .profile-details {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .detail-card {
            background: #f8f9ff;
            padding: 1.5rem;
            border-radius: 10px;
        }

        .detail-card h5 {
            margin-bottom: 1rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 0.7rem 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .detail-item:last-child {
            border-bottom: none;
        }

        .detail-label {
            color: var(--gray);
        }

        .detail-value {
            font-weight: 500;
        }

        .profile-actions {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e2e8f0;
        }

        .profile-actions p {
            margin-bottom: 1rem;
            font-weight: 500;
        }
/* Add this to your existing CSS */
.notification-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: var(--danger);
    color: white;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    font-size: 0.7rem;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
}

.header-nav-item {
    position: relative;
}

.sidebar li {
    position: relative;
}

/* Update existing sidebar and header styles to accommodate badges */
.sidebar li i, .header-nav-item i {
    position: relative;
}

.conversation.unread .conversation-name {
    font-weight: bold;
    color: var(--primary);
}

.conversation.unread .conversation-preview {
    font-weight: 600;
    color: var(--dark);
}
        #logoutBtn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        #logoutBtn:hover {
            background: #e53e3e;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(245, 101, 101, 0.3);
        }

        /* Login Page Styles */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        }

        .login-form {
            background: white;
            padding: 2.5rem;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            width: 100%;
            max-width: 400px;
        }

        .login-form h2 {
            text-align: center;
    margin-bottom: 1.5rem;
            color: var(--primary);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(108, 99, 255, 0.2);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .form-footer {
            text-align: center;
            margin-top: 1.5rem;
        }

        .form-footer a {
            color: var(--primary);
            text-decoration: none;
        }

        .form-footer a:hover {
            text-decoration: underline;
        }

        .error-message {
            color: var(--danger);
            font-size: 0.9rem;
            margin-top: 0.5rem;
            display: none;
        }

        .success-message {
            color: var(--success);
            font-size: 0.9rem;
            margin-top: 0.5rem;
            display: none;
        }

        /* Mobile menu toggle */
        .menu-toggle {
            display: none;
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 1001;
            background: var(--primary);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        /* Responsive Design */
        @media (max-width: 992px) {
            .sidebar {
                width: 70px;
                overflow: visible;
            }
            
            .sidebar li span {
                display: none;
            }
            
            .sidebar li i {
                margin-right: 0;
                font-size: 1.5rem;
            }
            
            .main-content {
                margin-left: 70px;
            }
            
            .messages-container {
                flex-direction: column;
                height: auto;
            }
            
            .conversations-list {
                width: 100%;
                max-height: 200px;
            }

            .header-nav {
                display: none;
            }

            .menu-toggle {
                display: flex;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                z-index: 999;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
                padding: 1rem;
            }
            
            .profile-header {
                flex-direction: column;
                text-align: center;
            }
            
            .profile-avatar-container {
                margin-right: 0;
                margin-bottom: 1rem;
            }
            
            .friends-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .friends-tabs {
                flex-direction: column;
            }
            
            .friends-tab {
                text-align: center;
            }
        }

        .hidden {
            display: none !important;
        }
        
        /* Upload Progress */
        .upload-progress {
            width: 100%;
            height: 5px;
            background-color: #e2e8f0;
            border-radius: 5px;
            margin-bottom: 1rem;
            overflow: hidden;
            display: none;
        }
        
        .upload-progress-bar {
            height: 100%;
            background-color: var(--primary);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }
        
        .no-results {
            text-align: center;
            padding: 2rem;
            color: var(--gray);
        }
       
/* Header Wallet Badge */
.wallet-badge {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: rgba(108, 99, 255, 0.1);
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 1px solid rgba(108, 99, 255, 0.2);
    margin-left: 1rem;
}

.wallet-badge:hover {
    background: rgba(108, 99, 255, 0.2);
    transform: translateY(-1px);
}

.wallet-badge i {
    color: var(--primary);
    font-size: 1rem;
}

.wallet-balance {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--primary);
}
/* Wallet Actions */
.wallet-actions {
    display: flex;
    gap: 1rem;
    margin-top: 1.5rem;
}

.wallet-action-btn {
    flex: 1;
    padding: 0.8rem 1rem;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    transition: all 0.3s ease;
}

.send-btn {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.3);
}

.send-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-2px);
}

.receive-btn {
    background: white;
    color: var(--primary);
}

.receive-btn:hover {
    background: #f0f0f0;
    transform: translateY(-2px);
}

/* Transactions Section */
.transactions-section {
    grid-column: 1 / -1;
    margin-top: 1rem;
}

.transactions-section h5 {
    margin-bottom: 1rem;
    color: var(--primary);
}

.transactions-list {
    display: flex;
    flex-direction: column;
    gap: 0.8rem;
}

.transaction-item {
    display: flex;
    align-items: center;
    padding: 1rem;
    background: #f8f9ff;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
    transition: all 0.3s ease;
}

.transaction-item:hover {
    background: white;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.transaction-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    font-size: 1rem;
}

.transaction-icon.send {
    background: rgba(245, 101, 101, 0.1);
    color: var(--danger);
}

.transaction-icon.receive {
    background: rgba(72, 187, 120, 0.1);
    color: var(--success);
}

.transaction-details {
    flex: 1;
}

.transaction-type {
    font-weight: 600;
    margin-bottom: 0.2rem;
}

.transaction-address {
    font-size: 0.8rem;
    color: var(--gray);
}

.transaction-amount {
    text-align: right;
}

.transaction-value {
    font-weight: bold;
    margin-bottom: 0.2rem;
}

.transaction-value.positive {
    color: var(--success);
}

.transaction-value.negative {
    color: var(--danger);
}

.transaction-time {
    font-size: 0.8rem;
    color: var(--gray);
}

/* Wallet Section Styles */
.wallet-info {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.wallet-card {
    background: linear-gradient(135deg, #6c63ff, #5a52d5);
    color: white;
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(108, 99, 255, 0.3);
}

.wallet-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.wallet-header h4 {
    margin: 0;
    color: white;
}

.network-badge {
    background: rgba(255, 255, 255, 0.2);
    padding: 0.3rem 0.8rem;
    border-radius: 20px;
    font-size: 0.8rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.network-badge i {
    color: #48bb78;
    font-size: 0.6rem;
}

.wallet-balance {
    text-align: center;
    margin-bottom: 1.5rem;
}

.balance-label {
    font-size: 0.9rem;
    opacity: 0.8;
    margin-bottom: 0.5rem;
}

.balance-amount {
    font-size: 2rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
}

.balance-usd {
    font-size: 1rem;
    opacity: 0.8;
}

.wallet-address {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: rgba(255, 255, 255, 0.1);
    padding: 0.8rem 1rem;
    border-radius: 8px;
}

.address-label {
    font-size: 0.8rem;
    opacity: 0.8;
}

.address-value {
    font-family: monospace;
    font-size: 0.9rem;
}

.copy-address {
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    padding: 0.3rem;
    border-radius: 4px;
    transition: background 0.3s ease;
}

.copy-address:hover {
    background: rgba(255, 255, 255, 0.2);
}

.assets-section {
    grid-column: 1 / -1;
}

.assets-section h5 {
    margin-bottom: 1rem;
    color: var(--primary);
}

.assets-list {
    display: flex;
    flex-direction: column;
    gap: 0.8rem;
}

.asset-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: #f8f9ff;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
}

.asset-info {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.asset-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--primary);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 0.8rem;
}

.asset-details h6 {
    margin: 0 0 0.2rem 0;
    font-size: 1rem;
}

.asset-details span {
    color: var(--gray);
    font-size: 0.8rem;
}

.asset-balance {
    text-align: right;
}

.asset-amount {
    font-weight: bold;
    margin-bottom: 0.2rem;
}

.asset-value {
    color: var(--gray);
    font-size: 0.8rem;
}
.wallet-overlay {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: #0a0a0a;
  color: #fff;
  z-index: 9999;
  display: flex;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  text-align: center;
}
.wallet-overlay-content h2 {
  font-size: 1.8rem;
  margin-bottom: 0.5rem;
}
.wallet-overlay-buttons {
  margin-top: 20px;
  display: flex;
  gap: 10px;
}
.wallet-overlay.hidden {
  display: none !important;
}
.btn-primary {
  background: #2f6dff;
  color: #fff;
  border: none;
  padding: 10px 16px;
  border-radius: 6px;
  cursor: pointer;
}
.btn-outline {
  background: transparent;
  border: 1px solid #2f6dff;
  color: #2f6dff;
  padding: 10px 16px;
  border-radius: 6px;
  cursor: pointer;
}
/* Post Actions - UPDATED */
.post-actions {
    display: flex;
    gap: 1rem;
    border-top: 1px solid #f0f0f0;
    padding-top: 1rem;
}

.post-action {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    color: var(--gray);
    transition: all 0.3s ease;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    flex: 1;
    justify-content: center;
}

.post-action:hover {
    background: #f8f9fa;
    color: var(--primary);
}

.post-action.liked {
    color: var(--danger);
}

.post-action.liked i {
    color: var(--danger);
}

.post-action i {
    transition: all 0.3s ease;
}

/* Comment Modal */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 2000;
}

.modal.hidden {
    display: none;
}

.modal-content {
    background: white;
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    max-height: 80vh;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid #e2e8f0;
}

.modal-header h4 {
    margin: 0;
    color: var(--primary);
}

.close {
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--gray);
}

.close:hover {
    color: var(--dark);
}

.modal-body {
    padding: 1.5rem;
    max-height: 60vh;
    overflow-y: auto;
}

.comment-input-container {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #e2e8f0;
}

#commentInput {
    flex: 1;
    padding: 0.8rem;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    outline: none;
}

#commentInput:focus {
    border-color: var(--primary);
}

#submitComment {
    background: var(--primary);
    color: white;
    border: none;
    padding: 0.8rem 1.2rem;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
}

#submitComment:hover {
    background: var(--primary-dark);
}

/* Comments List */
.comment {
    padding: 1rem 0;
    border-bottom: 1px solid #f0f0f0;
}

.comment:last-child {
    border-bottom: none;
}

.comment-header {
    display: flex;
    align-items: center;
    margin-bottom: 0.5rem;
}

.comment-avatar {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background: var(--primary);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 0.8rem;
    margin-right: 0.8rem;
}

.comment-user {
    font-weight: 600;
    font-size: 0.9rem;
}

.comment-time {
    font-size: 0.8rem;
    color: var(--gray);
    margin-left: auto;
}

.comment-text {
    font-size: 0.9rem;
    line-height: 1.4;
}


.telebirr-header {
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }

 .telebirr-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #00a859, #008e4a);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            margin-right: 1rem;
        }

        .telebirr-balance {
            flex: 1;
        }

        .telebirr-balance-label {
            font-size: 0.9rem;
            color: var(--gray);
            margin-bottom: 0.3rem;
        }

        .telebirr-balance-amount {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .telebirr-actions {
            display: flex;
            gap: 1rem;
        }

        .telebirr-btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .telebirr-deposit {
            background: var(--primary);
            color: white;
        }

        .telebirr-deposit:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(108, 99, 255, 0.3);
        }

        .telebirr-withdraw {
            background: var(--success);
            color: white;
        }

        .telebirr-withdraw:hover {
            background: #38a169;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(72, 187, 120, 0.3);
        }

        /* Telebirr Modal Styles */
        .telebirr-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            padding: 2rem;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .telebirr-modal.active {
            opacity: 1;
            visibility: visible;
        }

        .telebirr-modal-content {
            background: white;
            border-radius: 20px;
            padding: 2.5rem;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
            transform: translateY(20px);
            transition: transform 0.4s ease;
        }

        .telebirr-modal.active .telebirr-modal-content {
            transform: translateY(0);
        }

        .telebirr-modal-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #00a859, #008e4a);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            font-size: 2rem;
            color: white;
        }

        .telebirr-modal h3 {
            color: #2d3748;
            margin-bottom: 0.5rem;
            font-size: 1.8rem;
        }

        .telebirr-modal p {
            color: #718096;
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        .telebirr-form {
            text-align: left;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #2d3748;
        }

        .form-control {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(108, 99, 255, 0.1);
        }

        .telebirr-actions-modal {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .telebirr-action-btn {
            flex: 1;
            padding: 1rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .telebirr-cancel {
            background: #e2e8f0;
            color: #4a5568;
        }

        .telebirr-cancel:hover {
            background: #cbd5e0;
        }

        .telebirr-confirm {
            background: linear-gradient(135deg, #00a859, #008e4a);
            color: white;
        }

        .telebirr-confirm:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 168, 89, 0.4);
        }

        /* Transaction History */
        .telebirr-transactions {
            margin-top: 2rem;
        }

        .telebirr-transactions h4 {
            margin-bottom: 1rem;
            color: var(--primary);
        }

        .transaction-list {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        .transaction-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            background: #f8f9ff;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .transaction-item:hover {
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .transaction-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            font-size: 1rem;
        }

        .transaction-icon.deposit {
            background: rgba(72, 187, 120, 0.1);
            color: var(--success);
        }

        .transaction-icon.withdraw {
            background: rgba(245, 101, 101, 0.1);
            color: var(--danger);
        }

        .transaction-details {
            flex: 1;
        }

        .transaction-type {
            font-weight: 600;
            margin-bottom: 0.2rem;
        }

        .transaction-date {
            font-size: 0.8rem;
            color: var(--gray);
        }

        .transaction-amount {
            text-align: right;
        }

        .transaction-value {
            font-weight: bold;
            margin-bottom: 0.2rem;
        }

        .transaction-value.positive {
            color: var(--success);
        }

        .transaction-value.negative {
            color: var(--danger);
        }

        .transaction-status {
            font-size: 0.8rem;
            color: var(--gray);
        }

        .status-completed {
            color: var(--success);
        }

        .status-pending {
            color: var(--warning);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .telebirr-actions {
                flex-direction: column;
            }
            
            .telebirr-btn {
                width: 100%;
                justify-content: center;
            }
            
            .telebirr-actions-modal {
                flex-direction: column;
            }

/* Share Options */
.share-options {
    position: absolute;
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
    padding: 0.5rem;
    z-index: 100;
    min-width: 150px;
    display: none;
}

.share-options.show {
    display: block;
}

.share-option {
    padding: 0.8rem 1rem;
    cursor: pointer;
    border-radius: 6px;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.share-option:hover {
    background: #f8f9fa;
    color: var(--primary);
}
@media (max-width: 768px) {
    .wallet-info {
        grid-template-columns: 1fr;
    }
}
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-form">
            <h2>LaamSocial</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" class="form-control" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" class="form-control" placeholder="Enter your password" required>
                </div>
                <button type="submit" class="btn-primary" id="loginBtn">
                    <span id="loginBtnText">Login</span>
                    <div id="loginSpinner" class="hidden" style="display: inline-block; margin-left: 10px;">
                        <i class="fas fa-spinner fa-spin"></i>
                    </div>
                </button>
                <div class="error-message" id="loginError"></div>
                <div class="success-message" id="loginSuccess"></div>
            </form>
            <div class="form-footer">
                <p>Don't have an account? <a href="#" id="showRegister">Register</a></p>
            </div>
        </div>
    </div>

    <!-- Register Page -->
    <div id="registerPage" class="login-container hidden">
        <div class="login-form">
            <h2>Create Account</h2>
            <form id="registerForm">
                <div class="form-group">
                    <label for="registerName">Full Name</label>
                    <input type="text" id="registerName" class="form-control" placeholder="Enter your full name" required>
                </div>
                <div class="form-group">
                    <label for="registerUsername">Username</label>
                    <input type="text" id="registerUsername" class="form-control" placeholder="Choose a username" required>
                </div>
                <div class="form-group">
                    <label for="registerEmail">Email</label>
                    <input type="email" id="registerEmail" class="form-control" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label for="registerPassword">Password</label>
                    <input type="password" id="registerPassword" class="form-control" placeholder="Create a password (min 6 characters)" required minlength="6">
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Confirm Password</label>
                    <input type="password" id="confirmPassword" class="form-control" placeholder="Confirm your password" required>
                </div>
                <button type="submit" class="btn-primary" id="registerBtn">
                    <span id="registerBtnText">Register</span>
                    <div id="registerSpinner" class="hidden" style="display: inline-block; margin-left: 10px;">
                        <i class="fas fa-spinner fa-spin"></i>
                    </div>
                </button>
                <div class="error-message" id="registerError"></div>
                <div class="success-message" id="registerSuccess"></div>
            </form>
            <div class="form-footer">
                <p>Already have an account? <a href="#" id="showLogin">Login</a></p>
            </div>
        </div>
    </div>
     
        <div id="dashboard" class="hidden">
        <header>
            <h2>LaamSocial</h2>

    <nav class="header-nav">
        <div class="header-nav-item active" data-section="homeSection">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </div>
        <div class="header-nav-item" data-section="friendsSection">
            <i class="fas fa-user-friends"></i>
            <span>Friends</span>
        </div>
      <div class="header-nav-item" data-section="messagesSection">
    <i class="fas fa-comments"></i>
    <span>Messages</span>
    <div class="notification-badge" id="headerMessageBadge" style="display: none">0</div>
</div>
        <div class="header-nav-item" data-section="notificationsSection">
            <i class="fas fa-bell"></i>
            <span>Notifications</span>
        </div>
        <!-- ADD WALLET NAVIGATION ITEM -->
        <div class="header-nav-item" data-section="walletSection">
            <i class="fas fa-wallet"></i>
            <span>Wallet</span>
        </div>
        <div class="header-nav-item" data-section="profileSection">
            <i class="fas fa-user-cog"></i>
            <span>Profile</span>
        </div>
    </nav>
</header>

<div class="menu-toggle">
    <i class="fas fa-bars"></i>
</div>

<div class="container-dashboard">
    <!-- Sidebar / Menu -->
    <nav class="sidebar">
        <ul>
            <li class="active" data-section="homeSection">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </li>
            <li data-section="friendsSection">
                <i class="fas fa-user-friends"></i>
                <span>Friends</span>
            </li>
       <li data-section="messagesSection">
    <i class="fas fa-comments"></i>
    <span>Messages</span>
    <div class="notification-badge" id="sidebarMessageBadge" style="display: none">0</div>
</li>
            <li data-section="notificationsSection">
                <i class="fas fa-bell"></i>
                <span>Notifications</span>
            </li>
            <!-- ADD WALLET SIDEBAR ITEM -->
            <li data-section="walletSection">
                <i class="fas fa-wallet"></i>
                <span>Wallet</span>
            </li>


            <li data-section="profileSection">
                <i class="fas fa-user-cog"></i>
                <span>Profile / Settings</span>
            </li>
        </ul>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
 
      <!-- Qaybta Home Feed - UPDATED -->
<section id="homeSection" class="active">
  <h3>Home Feed</h3>
<div id="postSection">
    <textarea id="postText" placeholder="What's on your mind?"></textarea>

    <div class="file-upload-container">
        <label for="postImage" class="file-upload-label">
            <i class="fas fa-image"></i>
            <span>Add Image</span>
        </label>
        <input type="file" id="postImage" accept="image/*">
    </div>

    <div class="upload-progress" id="uploadProgress">
        <div class="upload-progress-bar" id="uploadProgressBar"></div>
    </div>

    <button id="postBtn">Post</button>

    <!--  Fariinta status + spinner -->
    <div id="postStatus" style="margin-top:8px; font-size:0.9rem; font-weight:500; color:#888;">
        <span id="postSpinner" class="spinner hidden"></span>
        <span id="postStatusText"></span>
    </div>
</div>

<div id="feed"></div>
</section>

<!-- Comment Modal -->
<div id="commentModal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h4>Comments</h4>
            <span class="close">&times;</span>
        </div>
        <div class="modal-body">
            <div id="commentsList"></div>
            <div class="comment-input-container">
                <input type="text" id="commentInput" placeholder="Write a comment...">
                <button id="submitComment">Post</button>
            </div>
        </div>
    </div>
</div>

        <!-- Friends Section -->
        <section id="friendsSection">
            <h3>Friends</h3>
            <div class="friends-tabs">
                <div class="friends-tab active" data-tab="allUsers">All Users</div>
                <div class="friends-tab" data-tab="friends">My Friends</div>
                <div class="friends-tab" data-tab="requests">Friend Requests</div>
                <div class="friends-tab" data-tab="search">Search Users</div>
            </div>
            
            <!-- All Users Tab -->
            <div class="friends-content active" id="allUsersTab">
                <div class="friends-grid" id="allUsersList">
                    <!-- All users will be loaded here -->
                </div>
            </div>
            
            <!-- My Friends Tab -->
            <div class="friends-content" id="friendsTab">
                <div class="friends-grid" id="friendsList">
                    <!-- Friends will be loaded here -->
                </div>
            </div>
            
            <!-- Friend Requests Tab -->
            <div class="friends-content" id="requestsTab">
                <h4>Pending Friend Requests</h4>
                <div class="requests-list" id="friendRequestsList">
                    <!-- Friend requests will be loaded here -->
                </div>
            </div>
            
            <!-- Search Users Tab -->
            <div class="friends-content" id="searchTab">
                <div class="search-container">
                    <input type="text" class="search-input" id="userSearch" placeholder="Search by username or name...">
                </div>
                <div class="friends-grid" id="searchResults">
                    <!-- Search results will be loaded here -->
                </div>
            </div>
        </section>

<!-- Messages Section - UPDATED -->
<!-- Messages Section - UPDATED -->
<section id="messagesSection">
    <h3>Messages</h3>
    <div class="messages-container">
        <div class="conversations-list" id="conversationsList">
            <!-- Conversations will be loaded here -->
        </div>
        
        <div class="chat-area">
            <div class="chat-header">
                <div class="chat-user-avatar" id="chatUserAvatar">?</div>
                <div class="chat-user-info">
                    <div class="chat-user-name" id="chatUserName">Select a conversation</div>
                    <div class="chat-user-status" id="chatUserStatus"></div>
                </div>
                <div class="chat-actions">
                    <div class="chat-action"><i class="fas fa-phone"></i></div>
                    <div class="chat-action"><i class="fas fa-video"></i></div>
                    <div class="chat-action"><i class="fas fa-ellipsis-v"></i></div>
                </div>
            </div>
            
            <div class="chat-messages" id="chatBox">
                <div class="message received">
                    Select a friend to start chatting
                    <div class="message-time">Now</div>
                </div>
            </div>

            <!-- Chat Image Preview -->
            <div id="chatImagePreview" class="chat-image-preview hidden"></div>

            <!-- Chat Upload Progress -->
            <div class="chat-upload-progress" id="chatUploadProgress">
                <div class="chat-upload-progress-bar" id="chatUploadProgressBar"></div>
            </div>
            
            <div class="chat-input-area">
                <!-- Image Attachment Button -->
                <div class="chat-input-actions">
                    <button id="attachImageBtn" type="button" title="Attach Image">
                        <i class="fas fa-image"></i>
                    </button>
                    <input type="file" id="chatImageInput" accept="image/*">
                </div>
                
                <input type="text" id="chatInput" placeholder="Type a message..." disabled>
                <button id="sendBtn" disabled><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>
</section>
        <!-- Notifications Section -->
        <section id="notificationsSection">
            <h3>Notifications</h3>
            <div id="notificationsList">
                <!-- Notifications will be loaded here -->
            </div>
        </section>


        <!-- ADD WALLET SECTION -->
<section id="walletSection">
    <h3>BSC Wallet</h3>

    <!-- Wallet Info -->
    <div class="wallet-info" id="walletInfo">
        <div class="wallet-card">
            <div class="wallet-header">
                <h4>BSC Mainnet Wallet</h4>
                <div class="network-badge">
                    <i class="fas fa-circle"></i>
                    BSC Mainnet
                </div>
            </div>

      
           <div class="wallet-balance">
                <div class="balance-label">Total Balance</div>
                <div class="balance-amount" id="totalBalance">0 BNB</div>
                <div class="balance-usd" id="balanceUSD">$0.00</div>
            </div>
            
            <div class="wallet-address">
                <div class="address-label">Wallet Address</div>
                <div class="address-value" id="walletAddress">-</div>
                <button class="copy-address" id="copyAddressBtn">
                    <i class="fas fa-copy"></i>
                </button>
            </div>
 
            <!-- ADD SEND & RECEIVE BUTTONS -->
            <div class="wallet-actions">
                <button class="wallet-action-btn send-btn" id="sendBtnWallet">
                    <i class="fas fa-paper-plane"></i>
                    Send
                </button>
                <button class="wallet-action-btn receive-btn" id="receiveBtnWallet">
                    <i class="fas fa-qrcode"></i>
                    Receive
                </button>
            </div>
        </div>
<!-- Send Transaction Modal with Step-by-Step Wizard -->
<div id="sendModal" class="send-modal hidden">
    <div class="send-modal-content fade-in-up">
        <!-- Step Indicator -->
        <div class="wizard-steps">
            <div class="step-indicator">
                <div class="step active" data-step="1">
                    <div class="step-number">1</div>
                    <div class="step-label">Amount</div>
                </div>
                <div class="step" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-label">Recipient</div>
                </div>
                <div class="step" data-step="3">
                    <div class="step-number">3</div>
                    <div class="step-label">Confirm</div>
                </div>
            </div>
        </div>

        <!-- Step 1: Amount Selection -->
        <div class="wizard-step active" id="step1">
            <div class="step-header">
                <div class="send-icon">
                    <i class="fas fa-coins"></i>
                </div>
                <div class="send-details">
                    <h3 style="margin: 0; color: #2d3748;">Send Amount</h3>
                    <p style="margin: 0; color: #718096;">How much would you like to send?</p>
                </div>
            </div>

            <div class="amount-section">
                <input type="text" id="sendAmount" class="send-amount-input" placeholder="0.00">
                
                <div class="currency-selector">
                    <div class="currency-option active" data-currency="BNB">
                        <div class="currency-icon">BNB</div>
                        <div class="currency-name">BNB</div>
                    </div>
                    <div class="currency-option" data-currency="USDT">
                        <div class="currency-icon">USDT</div>
                        <div class="currency-name">USDT</div>
                    </div>
                    <div class="currency-option" data-currency="USDC">
                        <div class="currency-icon">USDC</div>
                        <div class="currency-name">USDC</div>
                    </div>
                </div>

                <div class="balance-info">
                    <span>Available: </span>
                    <span id="availableBalance">0.00 BNB</span>
                </div>

                <div class="quick-amounts">
                    <button class="quick-amount" data-amount="0.1">0.1</button>
                    <button class="quick-amount" data-amount="0.5">0.5</button>
                    <button class="quick-amount" data-amount="1">1.0</button>
                    <button class="quick-amount" data-amount="5">5.0</button>
                </div>
            </div>

            <div class="step-actions">
                <button class="step-btn cancel" id="cancelSendBtn">
                    Cancel
                </button>
                <button class="step-btn next" id="step1Next">
                    Next <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- Step 2: Recipient Address -->
        <div class="wizard-step" id="step2">
            <div class="step-header">
                <div class="send-icon">
                    <i class="fas fa-user"></i>
                </div>
                <div class="send-details">
                    <h3 style="margin: 0; color: #2d3748;">Recipient Address</h3>
                    <p style="margin: 0; color: #718096;">Where should we send the funds?</p>
                </div>
            </div>

            <div class="recipient-section">
                <div class="address-input-group">
                    <label>Recipient Wallet Address</label>
                    <input type="text" id="recipientAddress" class="address-input" placeholder="0x...">
                    <div class="input-hint">Enter a valid BSC address</div>
                </div>

                <div class="recent-contacts">
                    <h4>Recent Contacts</h4>
                    <div class="contacts-list">
                        <!-- Recent contacts will be populated here -->
                        <div class="no-contacts">No recent contacts</div>
                    </div>
                </div>
            </div>

            <div class="step-actions">
                <button class="step-btn back" id="step2Back">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                <button class="step-btn next" id="step2Next">
                    Next <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- Step 3: Confirmation -->
        <div class="wizard-step" id="step3">
            <div class="step-header">
                <div class="send-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="send-details">
                    <h3 style="margin: 0; color: #2d3748;">Confirm Transaction</h3>
                    <p style="margin: 0; color: #718096;">Review your transaction details</p>
                </div>
            </div>

            <div class="confirmation-section">
                <div class="transaction-details">
                    <div class="detail-row">
                        <span class="detail-label">Amount</span>
                        <span class="detail-value" id="confirmAmount">0.00 BNB</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">To</span>
                        <span class="detail-value address" id="confirmAddress">0x...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Network Fee</span>
                        <span class="detail-value" id="confirmFee">0.001 BNB</span>
                    </div>
                    <div class="detail-row total">
                        <span class="detail-label">Total</span>
                        <span class="detail-value" id="confirmTotal">0.001 BNB</span>
                    </div>
                </div>

                <div class="security-notice">
                    <i class="fas fa-shield-alt"></i>
                    <span>This transaction is secured by the BSC network</span>
                </div>
            </div>

            <div class="step-actions">
                <button class="step-btn back" id="step3Back">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                <button class="step-btn confirm" id="confirmSendBtn">
                    <i class="fas fa-paper-plane"></i> Confirm & Send
                </button>
            </div>
        </div>
    </div>
</div>

        <!-- Assets List -->
        <div class="assets-section">
            <h5>Assets</h5>
            <div class="assets-list" id="assetsList">
                <!-- Assets will be loaded here -->
            </div>
        </div>
<!-- Wallet: Add Token input (paste inside walletSection where assetsList is) -->
<div style="margin-top:12px; display:flex; gap:8px; align-items:center;">
  <input id="newTokenAddress" class="form-control" placeholder="Token contract address (BSC/Base)" />
  <input id="newTokenSymbol" class="form-control" style="width:90px" placeholder="SYMB" />
  <input id="newTokenDecimals" class="form-control" style="width:90px" placeholder="dec" />
  <button id="addTokenBtn" class="btn-primary" style="padding:8px 12px">Add token</button>
</div>
        <!-- Transaction History -->
        <div class="transactions-section">
            <h5>Recent Transactions</h5>
            <div class="transactions-list" id="transactionsList">
                <div class="no-results">No transactions yet</div>
            </div>
        </div>
    </div>
   
<section id="walletSection">
  <h3>Wallet (Birr)</h3>

  <div class="detail-card" style="max-width:600px;">
    <div class="detail-item" style="display:flex;justify-content:space-between;align-items:center;">
      <div>
        <div class="detail-label">Balance</div>
        <div style="font-size:1.6rem;font-weight:700;color:var(--primary);" id="walletBalance">ETB0.00</div>
      </div>
      <div>
        <button id="depositTelebirrBtn" class="btn-primary">Deposit via Telebirr</button>
      </div>
    </div>

    <div style="margin-top:1rem;" id="depositStatus" class="detail-item hidden"></div>

    <hr/>

    <div>
      <label for="depositAmount">Amount (ETB)</label>
      <input id="depositAmount" class="form-control" type="number" min="1" value="100" />
    </div>
  </div>

<!-- Deposit Modal -->
<div id="depositModal" class="birr-modal">
    <div class="birr-modal-content">
        <div class="birr-modal-icon">
            <i class="fas fa-money-bill-wave"></i>
        </div>
        <h3>Deposit via Telebirr</h3>
        <p>Add funds to your LaamSocial wallet using Telebirr</p>
        
        <div class="birr-form">
            <div class="form-group">
                <label for="depositAmount">Amount (ETB)</label>
                <input type="number" id="depositAmount" class="form-control" placeholder="Enter amount" min="1" step="0.01">
            </div>
            <div class="form-group">
                <label for="depositPhone">Telephone Number</label>
                <input type="tel" id="depositPhone" class="form-control" placeholder="Enter your Telebirr phone number">
            </div>
            <div class="form-group">
                <label for="depositPin">Telebirr PIN</label>
                <input type="password" id="depositPin" class="form-control" placeholder="Enter your Telebirr PIN" maxlength="4">
            </div>
        </div>

        <div class="birr-actions-modal">
            <button class="birr-action-btn birr-cancel" id="cancelDepositBtn">
                Cancel
            </button>
            <button class="birr-action-btn birr-confirm" id="confirmDepositBtn">
                <i class="fas fa-check-circle"></i> Confirm Deposit
            </button>
        </div>
    </div>


<!-- Withdrawal Modal -->
<div id="withdrawModal" class="birr-modal">
    <div class="birr-modal-content">
        <div class="birr-modal-icon">
            <i class="fas fa-hand-holding-usd"></i>
        </div>
        <h3>Withdraw Funds</h3>
        <p>Transfer funds from your LaamSocial wallet to your bank account</p>
        
        <div class="birr-form">
            <div class="form-group">
                <label for="withdrawAmount">Amount (ETB)</label>
                <input type="number" id="withdrawAmount" class="form-control" placeholder="Enter amount" min="1" step="0.01">
            </div>
            <div class="form-group">
                <label for="withdrawBank">Bank Account</label>
                <select id="withdrawBank" class="form-control">
                    <option value="">Select your bank</option>
                    <option value="cbe">Commercial Bank of Ethiopia</option>
                    <option value="awash">Awash Bank</option>
                    <option value="dashen">Dashen Bank</option>
                    <option value="abyssinia">Bank of Abyssinia</option>
                    <option value="nib">NIB International Bank</option>
                </select>
            </div>
            <div class="form-group">
                <label for="withdrawAccount">Account Number</label>
                <input type="text" id="withdrawAccount" class="form-control" placeholder="Enter your account number">
            </div>
            <div class="form-group">
                <label for="withdrawPin">Security PIN</label>
                <input type="password" id="withdrawPin" class="form-control" placeholder="Enter your security PIN" maxlength="4">
            </div>
        </div>

        <div class="birr-actions-modal">
            <button class="birr-action-btn birr-cancel" id="cancelWithdrawBtn">
                Cancel
            </button>
            <button class="birr-action-btn birr-confirm" id="confirmWithdrawBtn">
                <i class="fas fa-check-circle"></i> Confirm Withdrawal
            </button>
        </div>
    </div>
</section>


        <!-- Profile / Settings Section -->
        <section id="profileSection">
            <h3>Profile / Settings</h3>
            <div class="profile-header">
                <div class="profile-avatar-container">
                    <img id="profilePicDisplay" src="https://via.placeholder.com/120" alt="Profile Picture">
                    <div class="profile-avatar-overlay">
                        <i class="fas fa-camera"></i>
                    </div>
                </div>
                <div class="profile-info">
                    <h4 id="profileName">Loading...</h4>
                    <p id="profileEmail">Loading...</p>
                    <p id="profileUsername">@username</p>
                    <p id="lastSeen">Last seen: Loading...</p>
                    <div class="profile-stats">
                        <div class="profile-stat">
                            <div class="stat-value" id="friendsCount">0</div>
                            <div class="stat-label">Friends</div>
                        </div>
                        <div class="profile-stat">
                            <div class="stat-value" id="postsCount">0</div>
                            <div class="stat-label">Posts</div>
                        </div>
                        <div class="profile-stat">
                            <div class="stat-value" id="messagesCount">0</div>
                            <div class="stat-label">Messages</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="profile-details">
                <div class="detail-card">
                    <h5><i class="fas fa-user"></i> Personal Information</h5>
                    <div class="detail-item">
                        <span class="detail-label">Full Name</span>
                        <span class="detail-value" id="profileFullName">Loading...</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Username</span>
                        <span class="detail-value" id="profileUsernameDetail">Loading...</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Email</span>
                        <span class="detail-value" id="profileEmailDetail">Loading...</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Member Since</span>
                        <span class="detail-value" id="memberSince">Loading...</span>
                    </div>
                </div>
                
                <div class="detail-card">
                    <h5><i class="fas fa-cog"></i> Account Settings</h5>
                    <div class="detail-item">
                        <span class="detail-label">Privacy</span>
                        <span class="detail-value">Friends</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Language</span>
                        <span class="detail-value">English</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Notifications</span>
                        <span class="detail-value">Enabled</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Theme</span>
                        <span class="detail-value">Light</span>
                    </div>
                </div>
            </div>
 

            <!-- User Email and Logout Button -->
            <div class="profile-actions">
                <p id="userEmailDisplay">Logged in as: Loading...</p>
                <button id="logoutBtn">Logout</button>
            </div>
        </section>
    </main>
</div>


    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>

    <script>
document.addEventListener('DOMContentLoaded', async function() {
    const walletAddress = "0xYourBSCWalletAddressHere"; //  halkan geli address-ka BSC main wallet-ka aad rabto inuu auto akhriyo
    const rpcURL = "https://bsc-dataseed.binance.org/";
    const web3 = new Web3(rpcURL);

    const walletAddressEl = document.getElementById('walletAddress');
    const totalBalanceEl = document.getElementById('totalBalance');
    const balanceUSDEl = document.getElementById('balanceUSD');
    const assetsList = document.getElementById('assetsList');

    // BNB balance
    const balanceWei = await web3.eth.getBalance(walletAddress);
    const balanceBNB = web3.utils.fromWei(balanceWei, 'ether');
    totalBalanceEl.textContent = `${parseFloat(balanceBNB).toFixed(4)} BNB`;

    // USD conversion (fixed rate)
    const bnbPrice = 300; // tusaale qiimo
    const usdValue = parseFloat(balanceBNB) * bnbPrice;
    balanceUSDEl.textContent = `$${usdValue.toFixed(2)} USD`;

    walletAddressEl.textContent = `${walletAddress.substring(0, 6)}...${walletAddress.substring(38)}`;

    // Token contracts (USDT & USDC BEP20)
    const tokens = [
        {
            name: "Tether USD",
            symbol: "USDT",
            address: "0x55d398326f99059fF775485246999027B3197955",
            decimals: 18
        },
        {
            name: "USD Coin",
            symbol: "USDC",
            address: "0x8ac76a51cc950d9822d68b83fe1ad97b32cd580d",
            decimals: 18
        }
    ];

    assetsList.innerHTML = "";

    // ERC20 ABI (balanceOf)
    const tokenABI = [
        { "constant":true, "inputs":[{"name":"_owner","type":"address"}], "name":"balanceOf", "outputs":[{"name":"balance","type":"uint256"}], "type":"function" },
        { "constant":true, "inputs":[],"name":"symbol","outputs":[{"name":"","type":"string"}],"type":"function" },
        { "constant":true, "inputs":[],"name":"name","outputs":[{"name":"","type":"string"}],"type":"function" }
    ];

    for (let token of tokens) {
        const contract = new web3.eth.Contract(tokenABI, token.address);
        const balance = await contract.methods.balanceOf(walletAddress).call();
        const balanceToken = balance / (10 ** token.decimals);
        
        const item = document.createElement('div');
        item.className = "asset-item";
        item.innerHTML = `
            <div class="asset-info">
                <div class="asset-icon">${token.symbol.substring(0,2)}</div>
                <div class="asset-details">
                    <h6>${token.name}</h6>
                    <span>${token.symbol}</span>
                </div>
            </div>
            <div class="asset-balance">
                <div class="asset-amount">${balanceToken.toFixed(4)}</div>
            </div>
        `;
        assetsList.appendChild(item);
    }
});

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDy_GTVZvwCZp8eLYvd_TUPI-uo_Jp5MpY",
            authDomain: "laamsocial-98cce.firebaseapp.com",
            projectId: "laamsocial-98cce",
            storageBucket: "laamsocial-98cce.firebasestorage.app",
            messagingSenderId: "649707204234",
            appId: "1:649707204234:web:2f22441b4dbbacc5674773"
        };

        // Initialize Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization error:", error);
        }
        
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
     // Cloudinary Configuration
        const CLOUDINARY_CLOUD_NAME = "dwbcovoit";
        const CLOUDINARY_UPLOAD_PRESET = "laamsocial_upload";

        // DOM Elements
        const loginPage = document.getElementById('loginPage');
        const registerPage = document.getElementById('registerPage');
        const dashboard = document.getElementById('dashboard');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const showRegister = document.getElementById('showRegister');
        const showLogin = document.getElementById('showLogin');
        const logoutBtn = document.getElementById('logoutBtn');
        const loginBtn = document.getElementById('loginBtn');
        const loginBtnText = document.getElementById('loginBtnText');
        const loginSpinner = document.getElementById('loginSpinner');
        const registerBtn = document.getElementById('registerBtn');
        const registerBtnText = document.getElementById('registerBtnText');
        const registerSpinner = document.getElementById('registerSpinner');
        const userEmailDisplay = document.getElementById('userEmailDisplay');
        const profileEmail = document.getElementById('profileEmail');
        const profileEmailDetail = document.getElementById('profileEmailDetail');
        const profileName = document.getElementById('profileName');
        const profileFullName = document.getElementById('profileFullName');
        const profileUsername = document.getElementById('profileUsername');
        const profileUsernameDetail = document.getElementById('profileUsernameDetail');
        const lastSeen = document.getElementById('lastSeen');
        const memberSince = document.getElementById('memberSince');
        const friendsCount = document.getElementById('friendsCount');
        const postsCount = document.getElementById('postsCount');
        const messagesCount = document.getElementById('messagesCount');
        const postBtn = document.getElementById('postBtn');
        const postText = document.getElementById('postText');
        const postImage = document.getElementById('postImage');
        const feed = document.getElementById('feed');
        const allUsersList = document.getElementById('allUsersList');
        const friendsList = document.getElementById('friendsList');
        const friendRequestsList = document.getElementById('friendRequestsList');
        const userSearch = document.getElementById('userSearch');
        const searchResults = document.getElementById('searchResults');
        const conversationsList = document.getElementById('conversationsList');
        const chatBox = document.getElementById('chatBox');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        const chatUserName = document.getElementById('chatUserName');
        const chatUserAvatar = document.getElementById('chatUserAvatar');
        const chatUserStatus = document.getElementById('chatUserStatus');
        const notificationsList = document.getElementById('notificationsList');
        const headerNavItems = document.querySelectorAll('.header-nav-item');
        const uploadProgress = document.getElementById('uploadProgress');
        const uploadProgressBar = document.getElementById('uploadProgressBar');
        const friendsTabs = document.querySelectorAll('.friends-tab');
        const friendsContents = document.querySelectorAll('.friends-content');
    

        // Current user and chat state
        let currentUser = null;
        let selectedChatId = null;
        let selectedUserId = null;
        let chatListener = null;
        let friends = [];
        let friendRequests = [];
        let selectedChatImage = null;
        let chatUploadTask = null;

     // NEW: Add these to your existing DOM elements
        const attachImageBtn = document.getElementById('attachImageBtn');
        const chatImageInput = document.getElementById('chatImageInput');
        const chatImagePreview = document.getElementById('chatImagePreview');
        const chatUploadProgress = document.getElementById('chatUploadProgress');
        const chatUploadProgressBar = document.getElementById('chatUploadProgressBar');
     // ... (Existing functions remain the same) ...

        // NEW: Event listener for attach image button in chat
        attachImageBtn.addEventListener('click', function() {
            chatImageInput.click();
        });

        // NEW: Event listener for file input in chat
        chatImageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                handleChatImageSelect(file);
            }
        });

        // NEW: Handle chat image selection
        function handleChatImageSelect(file) {
            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file.');
                return;
            }
            
            // Validate file size (5MB max)
            if (file.size > 5 * 1024 * 1024) {
                alert('Image size should be less than 5MB.');
                return;
            }
            
            selectedChatImage = file;
            
            // Show preview
            showChatImagePreview(file);
        }

        // NEW: Show chat image preview
        function showChatImagePreview(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                chatImagePreview.innerHTML = `
                    <img src="${e.target.result}" alt="Preview">
                    <button type="button" class="remove-chat-image" onclick="removeChatImage()">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                chatImagePreview.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }

        // NEW: Remove selected chat image
        function removeChatImage() {
            selectedChatImage = null;
            chatImageInput.value = '';
            chatImagePreview.classList.add('hidden');
            chatImagePreview.innerHTML = '';
        }

   
      //  SAX: Auth State Observer - kaliya wac loadPosts()



auth.onAuthStateChanged(user => {
    console.log("Auth state changed:", user);
    if (user) {
        currentUser = user;
        showDashboard();
        loadUserData();
        loadPosts();
        loadAllUsers();
        loadFriends();
        loadFriendRequests();
        loadConversations();
        loadNotifications();
        setupMessageNotifications();
        
        // Initialize navigation after everything is loaded
        setTimeout(() => {
            initializeNavigation();
        }, 100);
    } else {
        showLoginPage();
    }
});
// Add this to track when user views messages section
document.addEventListener('click', function(e) {
    if (e.target.closest('[data-section="messagesSection"]')) {
        // User clicked on messages section, you can add additional logic here
        console.log('User opened messages section');
    }
});

// Also update when switching sections to potentially mark all as read
function switchSection(sectionId) {
    // ... existing switch section code ...
    
    // If switching to messages section, you might want to mark all as read
    if (sectionId === 'messagesSection') {
        // Optional: Mark all messages as read when user enters messages section
        // Object.keys(unreadMessages).forEach(chatId => {
        //     markMessagesAsRead(chatId);
        // });
    }
}

        // Show login page
        function showLoginPage() {
            loginPage.classList.remove('hidden');
            registerPage.classList.add('hidden');
            dashboard.classList.add('hidden');
        }

        // Show register page
        function showRegisterPage() {
            loginPage.classList.add('hidden');
            registerPage.classList.remove('hidden');
            dashboard.classList.add('hidden');
        }

        // Show dashboard
        function showDashboard() {
            loginPage.classList.add('hidden');
            registerPage.classList.add('hidden');
            dashboard.classList.remove('hidden');
            if (currentUser) {
                userEmailDisplay.textContent = `Logged in as: ${currentUser.email}`;
            }
        }

        // Load user data
        function loadUserData() {
            if (!currentUser) return;
            
            db.collection('users').doc(currentUser.uid).get().then(doc => {
                if (doc.exists) {
                    const userData = doc.data();
                    profileName.textContent = userData.name || 'User';
                    profileFullName.textContent = userData.name || 'User';
                    profileEmail.textContent = currentUser.email;
                    profileEmailDetail.textContent = currentUser.email;
                    profileUsername.textContent = `@${userData.username || 'user'}`;
                    profileUsernameDetail.textContent = `@${userData.username || 'user'}`;
                    
                    // Format dates
                    const lastSeenDate = userData.lastSeen ? userData.lastSeen.toDate() : new Date();
                    lastSeen.textContent = `Last seen: ${formatDate(lastSeenDate)}`;
                    
                    const memberSinceDate = userData.createdAt ? userData.createdAt.toDate() : new Date();
                    memberSince.textContent = formatDate(memberSinceDate, true);
                } else {
                    // Create user document if it doesn't exist
                    const username = document.getElementById('registerUsername')?.value || 'user' + Math.floor(Math.random() * 1000);
                    db.collection('users').doc(currentUser.uid).set({
                        uid: currentUser.uid,
                        name: currentUser.displayName || 'User',
                        username: username,
                        email: currentUser.email,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                    }).then(() => {
                        console.log("User document created");
                        loadUserData(); // Reload user data
                    });
                }
            }).catch(error => {
                console.error("Error loading user data:", error);
            });
        }

        // Format date for display
        function formatDate(date, fullDate = false) {
            if (fullDate) {
                return date.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
            }
            
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} min ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
            
            return date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric' 
            });
        }

        // Upload image to Cloudinary
        async function uploadToCloudinary(file) {
            return new Promise((resolve, reject) => {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                
                // Show upload progress
                uploadProgress.style.display = 'block';
                
                const xhr = new XMLHttpRequest();
                
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percentComplete = (e.loaded / e.total) * 100;
                        uploadProgressBar.style.width = percentComplete + '%';
                    }
                });
                
                xhr.addEventListener('load', () => {
                    if (xhr.status === 200) {
                        const response = JSON.parse(xhr.responseText);
                        uploadProgress.style.display = 'none';
                        resolve(response.secure_url);
                    } else {
                        uploadProgress.style.display = 'none';
                        reject(new Error('Upload failed'));
                    }
                });
                
                xhr.addEventListener('error', () => {
                    uploadProgress.style.display = 'none';
                    reject(new Error('Upload failed'));
                });
                
                xhr.open('POST', `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`);
                xhr.send(formData);
            });
        }
//  SAX: Kaliya isticmaal loadPosts() - HA ISTICMAALIN real-time listener
function loadPosts() {
    if (!currentUser) return;
    
    db.collection('posts')
        .orderBy('createdAt', 'desc')
        .limit(20)
        .get()
        .then(snapshot => {
            feed.innerHTML = '';
            let count = 0;
            
            if (snapshot.empty) {
                feed.innerHTML = '<div class="post"><div class="post-content">No posts yet. Be the first to post something!</div></div>';
                postsCount.textContent = '0';
                return;
            }
            
            snapshot.forEach(doc => {
                const post = doc.data();
                if (post.authorName && post.createdAt) {
                    const postElement = createPostElement(post, doc.id);
                    feed.appendChild(postElement);
                    count++;
                }
            });
            
            postsCount.textContent = count;
        })
        .catch(error => {
            console.error("Error loading posts:", error);
            feed.innerHTML = '<div class="post"><div class="post-content">Error loading posts. Please try again.</div></div>';
        });
}

//  KA SAAR function-kan - HA ISTICMAALIN
// function setupPostsListener() { ... }
   // Create post element - UPDATED VERSION with working buttons
        function createPostElement(post, postId) {
            const postElement = document.createElement('div');
            postElement.className = 'post';
            postElement.dataset.postId = postId;
            
            // Get user initials for avatar
            const userName = post.authorName || 'Unknown';
            const userInitials = getUserInitials(userName);
            const username = post.authorUsername || 'user';
            
            let imageHtml = '';
            if (post.imageUrl) {
                imageHtml = `<img src="${post.imageUrl}" class="post-image" alt="Post image">`;
            }
            
            // Check if current user liked this post
            const isLiked = post.likedBy && post.likedBy.includes(currentUser.uid);
            
            postElement.innerHTML = `
                <div class="post-header">
                    <div class="post-avatar">${userInitials}</div>
                    <div class="post-user-info">
                        <div class="post-user">
                            ${userName}
                            <span class="post-username">@${username}</span>
                        </div>
                        <div class="post-time">${formatDate(post.createdAt.toDate())}</div>
                    </div>
                </div>
                <div class="post-content">
                    ${post.text || ''}
                </div>
                ${imageHtml}
                <div class="post-actions">
                    <div class="post-action like ${isLiked ? 'liked' : ''}" data-post-id="${postId}">
                        <i class="${isLiked ? 'fas' : 'far'} fa-heart"></i>
                        <span class="like-count">${post.likes || 0}</span>
                    </div>
                    <div class="post-action comment" data-post-id="${postId}">
                        <i class="far fa-comment"></i>
                        <span class="comment-count">${post.commentCount || 0}</span>
                    </div>
                    <div class="post-action share" data-post-id="${postId}">
                        <i class="far fa-share-square"></i>
                        <span class="share-count">${post.shares || 0}</span>
                    </div>
                </div>
            `;
            
            // Add event listeners for actions
            const likeBtn = postElement.querySelector('.like');
            const commentBtn = postElement.querySelector('.comment');
            const shareBtn = postElement.querySelector('.share');
            
            likeBtn.addEventListener('click', () => toggleLike(postId));
            commentBtn.addEventListener('click', () => openComments(postId));
            shareBtn.addEventListener('click', (e) => showShareOptions(e, postId));
            
            return postElement;
        }

        // Utility Functions
        function getUserInitials(name) {
            return name.split(' ').map(word => word[0]).join('').toUpperCase().slice(0, 2);
        }

        function formatDate(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days < 7) return `${days}d ago`;
            
            return date.toLocaleDateString();
        }

        // Toggle Like Function
        async function toggleLike(postId) {
            if (!currentUser) return;
            
            try {
                const postRef = db.collection('posts').doc(postId);
                const postDoc = await postRef.get();
                
                if (!postDoc.exists) return;
                
                const post = postDoc.data();
                const likedBy = post.likedBy || [];
                const isLiked = likedBy.includes(currentUser.uid);
                
                if (isLiked) {
                    // Remove like
                    await postRef.update({
                        likes: firebase.firestore.FieldValue.increment(-1),
                        likedBy: firebase.firestore.FieldValue.arrayRemove(currentUser.uid)
                    });
                } else {
                    // Add like
                    await postRef.update({
                        likes: firebase.firestore.FieldValue.increment(1),
                        likedBy: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
                    });
                }
                
            } catch (error) {
                console.error('Error toggling like:', error);
                alert('Error liking post. Please try again.');
            }
        }

        // Open Comments Modal
        async function openComments(postId) {
            currentPostId = postId;
            const modal = document.getElementById('commentModal');
            const commentsList = document.getElementById('commentsList');
            
            // Load comments
            await loadComments(postId);
            
            // Show modal
            modal.classList.remove('hidden');
            
            // Focus on comment input
            setTimeout(() => {
                document.getElementById('commentInput').focus();
            }, 100);
        }

        // Close Comments Modal
        function closeComments() {
            const modal = document.getElementById('commentModal');
            modal.classList.add('hidden');
            currentPostId = null;
        }

        // Load Comments Function
        async function loadComments(postId) {
            const commentsList = document.getElementById('commentsList');
            commentsList.innerHTML = '<div class="no-results">Loading comments...</div>';
            
            try {
                const snapshot = await db.collection('posts')
                    .doc(postId)
                    .collection('comments')
                    .orderBy('createdAt', 'asc')
                    .get();
                
                commentsList.innerHTML = '';
                
                if (snapshot.empty) {
                    commentsList.innerHTML = '<div class="no-results">No comments yet. Be the first to comment!</div>';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const comment = doc.data();
                    const commentElement = createCommentElement(comment);
                    commentsList.appendChild(commentElement);
                });
                
            } catch (error) {
                console.error('Error loading comments:', error);
                commentsList.innerHTML = '<div class="no-results">Error loading comments.</div>';
            }
        }

        // Create Comment Element
        function createCommentElement(comment) {
            const commentElement = document.createElement('div');
            commentElement.className = 'comment';
            
            const userInitials = getUserInitials(comment.authorName);
            
            commentElement.innerHTML = `
                <div class="comment-header">
                    <div class="comment-avatar">${userInitials}</div>
                    <div class="comment-user">${comment.authorName}</div>
                    <div class="comment-time">${formatDate(comment.createdAt.toDate())}</div>
                </div>
                <div class="comment-text">${comment.text}</div>
            `;
            
            return commentElement;
        }

        // Submit Comment Function
        async function submitComment() {
            if (!currentUser || !currentPostId) return;
            
            const commentInput = document.getElementById('commentInput');
            const text = commentInput.value.trim();
            
            if (!text) {
                alert('Please enter a comment.');
                return;
            }
            
            try {
                // Get user data
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                const userData = userDoc.data();
                
                // Add comment to subcollection
                await db.collection('posts')
                    .doc(currentPostId)
                    .collection('comments')
                    .add({
                        text: text,
                        authorId: currentUser.uid,
                        authorName: userData.name || 'User',
                        authorUsername: userData.username || 'user',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                
                // Update comment count
                await db.collection('posts')
                    .doc(currentPostId)
                    .update({
                        commentCount: firebase.firestore.FieldValue.increment(1)
                    });
                
                // Clear input and reload comments
                commentInput.value = '';
                await loadComments(currentPostId);
                
            } catch (error) {
                console.error('Error submitting comment:', error);
                alert('Error posting comment. Please try again.');
            }
        }

        // Show Share Options
        function showShareOptions(event, postId) {
            // Remove any existing share options
            const existingOptions = document.querySelector('.share-options');
            if (existingOptions) {
                existingOptions.remove();
            }
            
            // Create share options
            const shareOptions = document.createElement('div');
            shareOptions.className = 'share-options show';
            shareOptions.innerHTML = `
                <div class="share-option" data-action="copy">
                    <i class="fas fa-link"></i>
                    <span>Copy Link</span>
                </div>
                <div class="share-option" data-action="share">
                    <i class="fas fa-share-alt"></i>
                    <span>Share Post</span>
                </div>
            `;
            
            // Position near the share button
            const shareBtn = event.target.closest('.share');
            const rect = shareBtn.getBoundingClientRect();
            shareOptions.style.position = 'fixed';
            shareOptions.style.top = `${rect.bottom + 5}px`;
            shareOptions.style.left = `${rect.left}px`;
            
            document.body.appendChild(shareOptions);
            
            // Add event listeners for share options
            shareOptions.addEventListener('click', (e) => {
                const option = e.target.closest('.share-option');
                if (option) {
                    const action = option.dataset.action;
                    handleShareAction(action, postId);
                }
            });
            
            // Close when clicking outside
            setTimeout(() => {
                const closeShareOptions = (e) => {
                    if (!shareOptions.contains(e.target) && !shareBtn.contains(e.target)) {
                        shareOptions.remove();
                        document.removeEventListener('click', closeShareOptions);
                    }
                };
                document.addEventListener('click', closeShareOptions);
            }, 100);
        }

        // Handle Share Actions
        async function handleShareAction(action, postId) {
            try {
                const postRef = db.collection('posts').doc(postId);
                
                if (action === 'copy') {
                    // Copy post link to clipboard
                    const postUrl = `${window.location.origin}?post=${postId}`;
                    await navigator.clipboard.writeText(postUrl);
                    alert('Post link copied to clipboard!');
                } else if (action === 'share') {
                    // Increment share count
                    await postRef.update({
                        shares: firebase.firestore.FieldValue.increment(1)
                    });
                    alert('Post shared successfully!');
                }
                
                // Remove share options
                const shareOptions = document.querySelector('.share-options');
                if (shareOptions) {
                    shareOptions.remove();
                }
                
            } catch (error) {
                console.error('Error handling share action:', error);
                alert('Error sharing post. Please try again.');
            }
        }
// Connect submit button to submitComment()
document.getElementById('submitComment').addEventListener('click', submitComment);

// Close modal button
document.querySelector('#commentModal .close').addEventListener('click', () => {
    document.getElementById('commentModal').classList.add('hidden');
});

      // Get user initials
        function getUserInitials(name) {
            return name.split(' ').map(part => part[0]).join('').toUpperCase().substring(0, 2);
        }

        // Load all users - FIXED VERSION
        function loadAllUsers() {
            if (!currentUser) return;
            
            db.collection('users').get()
                .then(snapshot => {
                    allUsersList.innerHTML = '';
                    let usersFound = false;
                    
                    snapshot.forEach(doc => {
                        const user = doc.data();
                        // Filter out current user
                        if (user.uid !== currentUser.uid) {
                            const userElement = createUserElement(user, 'all');
                            allUsersList.appendChild(userElement);
                            usersFound = true;
                        }
                    });
                    
                    if (!usersFound) {
                        allUsersList.innerHTML = '<div class="no-results">No users found.</div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading all users:', error);
                    allUsersList.innerHTML = '<div class="no-results">Error loading users. Please try again.</div>';
                });
        }

        // Load friends - FIXED VERSION
        function loadFriends() {
            if (!currentUser) return;
            
            db.collection('users').get()
                .then(snapshot => {
                    friendsList.innerHTML = '';
                    let count = 0;
                    
                    snapshot.forEach(doc => {
                        const user = doc.data();
                        // Filter out current user
                        if (user.uid !== currentUser.uid) {
                            const friendElement = createUserElement(user, 'friend');
                            friendsList.appendChild(friendElement);
                            count++;
                        }
                    });
                    
                    friendsCount.textContent = count;
                    
                    if (count === 0) {
                        friendsList.innerHTML = '<div class="no-results">No friends yet.</div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading friends:', error);
                    friendsList.innerHTML = '<div class="no-results">Error loading friends. Please try again.</div>';
                });
        }

        // Load friend requests - FIXED VERSION
        function loadFriendRequests() {
            if (!currentUser) return;
            
            // For demo purposes, we'll show some users as having sent requests
            db.collection('users').get()
                .then(snapshot => {
                    friendRequestsList.innerHTML = '';
                    friendRequests = [];
                    let requestsFound = false;
                    
                    snapshot.forEach(doc => {
                        const user = doc.data();
                        // Filter out current user and randomly select some as having sent requests
                        if (user.uid !== currentUser.uid && Math.random() > 0.7) {
                            friendRequests.push({
                                id: user.uid,
                                name: user.name,
                                username: user.username
                            });
                            
                            const requestElement = createRequestElement(user);
                            friendRequestsList.appendChild(requestElement);
                            requestsFound = true;
                        }
                    });
                    
                    if (!requestsFound) {
                        friendRequestsList.innerHTML = '<div class="no-results">No pending friend requests.</div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading friend requests:', error);
                    friendRequestsList.innerHTML = '<div class="no-results">Error loading requests. Please try again.</div>';
                });
        }

        // Create user element for different contexts
        function createUserElement(user, context) {
            const userElement = document.createElement('div');
            userElement.className = 'friend-card';
            
            const userInitials = getUserInitials(user.name);
            const isOnline = Math.random() > 0.5; // Random online status for demo
            
            let actionsHtml = '';
            
            if (context === 'all') {
                actionsHtml = `
                    <div class="friend-actions">
                        <div class="friend-action add" data-userid="${user.uid}">
                            <i class="fas fa-user-plus"></i> Add Friend
                        </div>
                        <div class="friend-action message" data-userid="${user.uid}">
                            <i class="fas fa-comment"></i> Message
                        </div>
                    </div>
                `;
            } else if (context === 'friend') {
                actionsHtml = `
                    <div class="friend-actions">
                        <div class="friend-action message" data-userid="${user.uid}">
                            <i class="fas fa-comment"></i> Message
                        </div>
                        <div class="friend-action remove" data-userid="${user.uid}">
                            <i class="fas fa-user-minus"></i> Remove
                        </div>
                    </div>
                `;
            } else if (context === 'search') {
                actionsHtml = `
                    <div class="friend-actions">
                        <div class="friend-action add" data-userid="${user.uid}">
                            <i class="fas fa-user-plus"></i> Add Friend
                        </div>
                        <div class="friend-action message" data-userid="${user.uid}">
                            <i class="fas fa-comment"></i> Message
                        </div>
                    </div>
                `;
            }
            
            userElement.innerHTML = `
                <div class="friend-avatar">${userInitials}</div>
                <div class="friend-name">${user.name}</div>
                <div class="friend-username">@${user.username || 'user'}</div>
                <div class="friend-status ${isOnline ? 'online' : 'offline'}">${isOnline ? 'Online' : 'Offline'}</div>
                ${actionsHtml}
            `;
            
            // Add event listeners
            const addBtn = userElement.querySelector('.friend-action.add');
            if (addBtn) {
                addBtn.addEventListener('click', () => {
                    sendFriendRequest(user);
                });
            }
            
            const messageBtn = userElement.querySelector('.friend-action.message');
            if (messageBtn) {
                messageBtn.addEventListener('click', () => {
                    startChatWithUser(user);
                });
            }
            
            const removeBtn = userElement.querySelector('.friend-action.remove');
            if (removeBtn) {
                removeBtn.addEventListener('click', () => {
                    removeFriend(user);
                });
            }
            
            return userElement;
        }

        // Create friend request element
        function createRequestElement(user) {
            const requestElement = document.createElement('div');
            requestElement.className = 'request-item';
            
            const userInitials = getUserInitials(user.name);
            
            requestElement.innerHTML = `
                <div class="request-avatar">${userInitials}</div>
                <div class="request-info">
                    <div class="request-name">${user.name}</div>
                    <div class="request-username">@${user.username || 'user'}</div>
                </div>
                <div class="request-actions">
                    <div class="request-action confirm" data-userid="${user.uid}">
                        <i class="fas fa-check"></i> Confirm
                    </div>
                    <div class="request-action reject" data-userid="${user.uid}">
                        <i class="fas fa-times"></i> Reject
                    </div>
                </div>
            `;
            
            // Add event listeners
            const confirmBtn = requestElement.querySelector('.request-action.confirm');
            confirmBtn.addEventListener('click', () => {
                confirmFriendRequest(user);
            });
            
            const rejectBtn = requestElement.querySelector('.request-action.reject');
            rejectBtn.addEventListener('click', () => {
                rejectFriendRequest(user);
            });
            
            return requestElement;
        }

        // Send friend request
        function sendFriendRequest(user) {
            if (!currentUser) return;
            
            // In a real app, you would add a document to friend_requests collection
            alert(`Friend request sent to ${user.name} (@${user.username})`);
            
            // Update UI
            const userCards = document.querySelectorAll(`.friend-action.add[data-userid="${user.uid}"]`);
            userCards.forEach(card => {
                card.innerHTML = '<i class="fas fa-clock"></i> Request Sent';
                card.classList.remove('add');
                card.style.color = 'var(--gray)';
                card.style.pointerEvents = 'none';
            });
        }

        // Confirm friend request
        function confirmFriendRequest(user) {
            // In a real app, you would update the friend request status
            alert(`You are now friends with ${user.name} (@${user.username})`);
            
            // Remove from requests list
            const requestItem = document.querySelector(`.request-item .request-action[data-userid="${user.uid}"]`).closest('.request-item');
            if (requestItem) {
                requestItem.remove();
            }
            
            // Update friends list
            loadFriends();
        }

        // Reject friend request
        function rejectFriendRequest(user) {
            // In a real app, you would update the friend request status
            alert(`Friend request from ${user.name} rejected`);
            
            // Remove from requests list
            const requestItem = document.querySelector(`.request-item .request-action[data-userid="${user.uid}"]`).closest('.request-item');
            if (requestItem) {
                requestItem.remove();
            }
        }

        // Remove friend
        function removeFriend(user) {
            if (confirm(`Are you sure you want to remove ${user.name} from your friends?`)) {
                // In a real app, you would update the friendship status
                alert(`${user.name} has been removed from your friends`);
                
                // Update friends list
                loadFriends();
            }
        }

        // Search users - FIXED VERSION
        function searchUsers(query) {
            if (!currentUser || !query) return;
            
            db.collection('users').get()
                .then(snapshot => {
                    searchResults.innerHTML = '';
                    let found = false;
                    
                    snapshot.forEach(doc => {
                        const user = doc.data();
                        // Filter out current user
                        if (user.uid !== currentUser.uid) {
                            const searchText = (user.name + ' ' + user.username).toLowerCase();
                            
                            if (searchText.includes(query.toLowerCase())) {
                                const userElement = createUserElement(user, 'search');
                                searchResults.appendChild(userElement);
                                found = true;
                            }
                        }
                    });
                    
                    if (!found) {
                        searchResults.innerHTML = '<div class="no-results">No users found matching your search.</div>';
                    }
                })
                .catch(error => {
                    console.error('Error searching users:', error);
                    searchResults.innerHTML = '<div class="no-results">Error searching users.</div>';
                });
        }

        // Load conversations - FIXED VERSION
        function loadConversations() {
            if (!currentUser) return;
            
            db.collection('users').get()
                .then(snapshot => {
                    conversationsList.innerHTML = '';
                    let conversationsFound = false;
                    
                    snapshot.forEach(doc => {
                        const user = doc.data();
                        // Filter out current user
                        if (user.uid !== currentUser.uid) {
                            const conversationElement = createConversationElement(user);
                            conversationsList.appendChild(conversationElement);
                            conversationsFound = true;
                        }
                    });
                    
                    if (!conversationsFound) {
                        conversationsList.innerHTML = '<div class="no-results">No conversations yet.</div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading conversations:', error);
                    conversationsList.innerHTML = '<div class="no-results">Error loading conversations.</div>';
                });
        }
        // Create conversation element
        function createConversationElement(user) {
            const conversationElement = document.createElement('div');
            conversationElement.className = 'conversation';
            conversationElement.dataset.userId = user.uid;
            
            const userInitials = getUserInitials(user.name);
            
            conversationElement.innerHTML = `
                <div class="conversation-avatar">${userInitials}</div>
                <div class="conversation-info">
                    <div class="conversation-name">${user.name}</div>
                    <div class="conversation-preview">@${user.username || 'user'}</div>
                </div>
                <div class="conversation-time">Now</div>
            `;
            
            conversationElement.addEventListener('click', () => {
                startChatWithUser(user);
            });
            
            return conversationElement;
        }

        // Start chat with user
        // Start chat with user - UPDATED VERSION
function startChatWithUser(user) {
    // Switch to messages section first
    switchSection('messagesSection');
    
    // Set chat user info
    selectedUserId = user.uid;
    chatUserName.textContent = user.name;
    chatUserAvatar.textContent = getUserInitials(user.name);
    chatUserStatus.textContent = 'Online';
    
    // Enable chat input
    chatInput.disabled = false;
    sendBtn.disabled = false;
    
    // Clear previous chat listener
    if (chatListener) {
        chatListener();
    }
    
    // Generate chat ID (combination of both user IDs, sorted)
    const chatId = [currentUser.uid, user.uid].sort().join('_');
    selectedChatId = chatId;
    
    // Load messages for this chat
    loadChatMessages(chatId);
    
    // Update UI to show active conversation
    document.querySelectorAll('.conversation').forEach(conv => {
        conv.classList.remove('active');
        if (conv.dataset.userId === user.uid) {
            conv.classList.add('active');
        }
    });
    
    // Scroll to messages section
    document.getElementById('messagesSection').scrollIntoView({ behavior: 'smooth' });
}

        // Load chat messages
        function loadChatMessages(chatId) {
            chatBox.innerHTML = '<div class="message received">Starting a new conversation</div>';
            
            chatListener = db.collection('chats')
                .doc(chatId)
                .collection('messages')
                .orderBy('timestamp', 'asc')
                .onSnapshot(snapshot => {
                    chatBox.innerHTML = '';
                    let count = 0;
                    
                    snapshot.forEach(doc => {
                        const message = doc.data();
                        const messageElement = createMessageElement(message);
                        chatBox.appendChild(messageElement);
                        count++;
                    });
                    
                    messagesCount.textContent = count;
                    
                    // Scroll to bottom
                    chatBox.scrollTop = chatBox.scrollHeight;
                    
                    if (snapshot.empty) {
                        chatBox.innerHTML = '<div class="message received">No messages yet. Start the conversation!</div>';
                    }
                }, error => {
                    console.error("Error loading messages:", error);
                    chatBox.innerHTML = '<div class="message received">Error loading messages.</div>';
                });
        }

        // Create message element
        function createMessageElement(message) {
            const messageElement = document.createElement('div');
            const isSent = message.senderId === currentUser.uid;
            
            messageElement.className = `message ${isSent ? 'sent' : 'received'}`;
            messageElement.innerHTML = `
                ${message.text}
                <div class="message-time">${formatDate(message.timestamp.toDate())}</div>
            `;
            
            return messageElement;
        }

        // Load notifications
        function loadNotifications() {
            // In a real app, you would query the user's notifications
            // For demo, we'll create some mock notifications
            const notifications = [
                {
                    type: 'friend_request',
                    title: 'Michael Jordan sent you a friend request',
                    time: new Date(Date.now() - 5 * 60000) // 5 minutes ago
                },
                {
                    type: 'like',
                    title: 'Sarah Roberts liked your post',
                    time: new Date(Date.now() - 2 * 3600000) // 2 hours ago
                },
                {
                    type: 'comment',
                    title: 'David Wilson commented on your photo',
                    time: new Date(Date.now() - 5 * 3600000) // 5 hours ago
                }
            ];
            
            notificationsList.innerHTML = '';
            
            notifications.forEach(notification => {
                const notificationElement = createNotificationElement(notification);
                notificationsList.appendChild(notificationElement);
            });
        }

        // Create notification element
        function createNotificationElement(notification) {
            const notificationElement = document.createElement('div');
            notificationElement.className = 'notification unread';
            
            let icon = 'fas fa-bell';
            if (notification.type === 'friend_request') icon = 'fas fa-user-plus';
            if (notification.type === 'like') icon = 'fas fa-heart';
            if (notification.type === 'comment') icon = 'fas fa-comment';
            
            notificationElement.innerHTML = `
                <div class="notification-icon">
                    <i class="${icon}"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">${notification.title}</div>
                    <div class="notification-time">${formatDate(notification.time)}</div>
                </div>
            `;
            
            return notificationElement;
        }

        // Event Listeners
        loginForm.addEventListener('submit', e => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorElement = document.getElementById('loginError');
            const successElement = document.getElementById('loginSuccess');
            
            // Reset messages
            errorElement.style.display = 'none';
            successElement.style.display = 'none';
            
            // Show loading state
            loginBtn.classList.add('loading');
            loginBtnText.textContent = 'Logging in...';
            loginSpinner.classList.remove('hidden');
            
            auth.signInWithEmailAndPassword(email, password)
                .then(userCredential => {
                    // Signed in
                    errorElement.style.display = 'none';
                    successElement.textContent = 'Login successful!';
                    successElement.style.display = 'block';
                    console.log("User signed in:", userCredential.user);
                })
                .catch(error => {
                    console.error("Login error:", error);
                    errorElement.textContent = error.message;
                    errorElement.style.display = 'block';
                })
                .finally(() => {
                    // Reset loading state
                    loginBtn.classList.remove('loading');
                    loginBtnText.textContent = 'Login';
                    loginSpinner.classList.add('hidden');
                });
        });

        registerForm.addEventListener('submit', e => {
            e.preventDefault();
            const name = document.getElementById('registerName').value;
            const username = document.getElementById('registerUsername').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const errorElement = document.getElementById('registerError');
            const successElement = document.getElementById('registerSuccess');
            
            // Reset messages
            errorElement.style.display = 'none';
            successElement.style.display = 'none';
            
            if (password !== confirmPassword) {
                errorElement.textContent = 'Passwords do not match';
                errorElement.style.display = 'block';
                return;
            }
            
            if (password.length < 6) {
                errorElement.textContent = 'Password must be at least 6 characters';
                errorElement.style.display = 'block';
                return;
            }
            
            // Show loading state
            registerBtn.classList.add('loading');
            registerBtnText.textContent = 'Creating account...';
            registerSpinner.classList.remove('hidden');

            // Check if username already exists
            db.collection('users').where('username', '==', username).get()
                .then(snapshot => {
                    if (!snapshot.empty) {
                        throw new Error('Username already exists');
                    }
                    
                    // Create user with auth
                    return auth.createUserWithEmailAndPassword(email, password);
                })
                .then(userCredential => {
                    // Signed up
                    const user = userCredential.user;
                    console.log("User created:", user);
                    
                    // Create user document in Firestore
                    return db.collection('users').doc(user.uid).set({
                        uid: user.uid,
                        name: name,
                        username: username,
                        email: email,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                    });
                })
                .then(() => {
                    errorElement.style.display = 'none';
                    successElement.textContent = 'Account created successfully!';
                    successElement.style.display = 'block';
                    console.log("User document created in Firestore");
                    
                    // Clear form
                    registerForm.reset();
                })
                .catch(error => {
                    console.error("Registration error:", error);
                    errorElement.textContent = error.message;
                    errorElement.style.display = 'block';
                })
                .finally(() => {
                    // Reset loading state
                    registerBtn.classList.remove('loading');
                    registerBtnText.textContent = 'Register';
                    registerSpinner.classList.add('hidden');
                });
        });

        showRegister.addEventListener('click', e => {
            e.preventDefault();
            showRegisterPage();
        });

        showLogin.addEventListener('click', e => {
            e.preventDefault();
            showLoginPage();
        });

        logoutBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to logout?')) {
                auth.signOut().then(() => {
                    console.log("User signed out");
                }).catch(error => {
                    console.error("Logout error:", error);
                });
            }
        });

        postBtn.addEventListener('click', async () => {
            if (!currentUser) {
                alert('Please login to post');
                return;
            }
            
            const text = postText.value.trim();
            const file = postImage.files[0];
            
            if (!text && !file) {
                alert('Please enter some text or select an image to post.');
                return;
            }
                  // Get current user data to include username in post
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            const userData = userDoc.data();
            
            let imageUrl = null;
            
            if (file) {
                try {
                    imageUrl = await uploadToCloudinary(file);
                } catch (error) {
                    console.error('Error uploading image:', error);
                    alert('Error uploading image. Please try again.');
                    return;
                }
            }
            
            
            // Create post in Firestore
            db.collection('posts').add({
                text: text,
                authorId: currentUser.uid,
                authorName: userData.name || 'User',
                authorUsername: userData.username || 'user',
                imageUrl: imageUrl,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                likes: 0,
                comments: 0,
                shares: 0
            })
            .then(() => {
                postText.value = '';
                postImage.value = '';
            })
            .catch(error => {
                console.error('Error creating post:', error);
                alert('Error creating post. Please try again.');
            });
        });

        sendBtn.addEventListener('click', sendMessage);

        chatInput.addEventListener('keypress', e => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        function sendMessage() {
            if (!currentUser || !selectedChatId) return;
            
            const text = chatInput.value.trim();
            if (text) {
                // Add message to Firestore
                db.collection('chats')
                    .doc(selectedChatId)
                    .collection('messages')
                    .add({
                        text: text,
                        senderId: currentUser.uid,
                        senderName: currentUser.displayName || 'User',
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    })
                    .then(() => {
                        chatInput.value = '';
                    })
                    .catch(error => {
                        console.error('Error sending message:', error);
                        alert('Error sending message. Please try again.');
                    });
            }
        }

        // Friends tabs navigation
        friendsTabs.forEach(tab => {
            tab.addEventListener('click', function() {
                const tabId = this.getAttribute('data-tab');
                
                // Update active tab
                friendsTabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // Show corresponding content
                friendsContents.forEach(content => {
                    content.classList.remove('active');
                    if (content.id === tabId + 'Tab') {
                        content.classList.add('active');
                    }
                });
                
                // If search tab is selected, focus on search input
                if (tabId === 'search') {
                    setTimeout(() => {
                        userSearch.focus();
                    }, 100);
                }
            });
        });

        // User search functionality
        userSearch.addEventListener('input', function() {
            const query = this.value.trim();
            if (query) {
                searchUsers(query);
            } else {
                searchResults.innerHTML = '<div class="no-results">Enter a username or name to search</div>';
            }
        });

        // Menu Navigation for Sidebar
        const menuItems = document.querySelectorAll('.sidebar li');
        const sections = document.querySelectorAll('.main-content section');
        
        menuItems.forEach(item => {
            item.addEventListener('click', function() {
                const targetSection = this.getAttribute('data-section');
                
                // Update active menu item
                menuItems.forEach(i => i.classList.remove('active'));
                this.classList.add('active');
                
                // Show target section
                sections.forEach(section => {
                    section.classList.remove('active');
                    if (section.id === targetSection) {
                        section.classList.add('active');
                    }
                });

                // Update header navigation
                headerNavItems.forEach(navItem => {
                    navItem.classList.remove('active');
                    if (navItem.getAttribute('data-section') === targetSection) {
                        navItem.classList.add('active');
                    }
                });
            });
        });

        // Header Navigation
        headerNavItems.forEach(item => {
            item.addEventListener('click', function() {
                const targetSection = this.getAttribute('data-section');
                
                // Update active header nav item
                headerNavItems.forEach(i => i.classList.remove('active'));
                this.classList.add('active');
                
                // Update sidebar
                menuItems.forEach(menuItem => {
                    menuItem.classList.remove('active');
                    if (menuItem.getAttribute('data-section') === targetSection) {
                        menuItem.classList.add('active');
                    }
                });
                
                // Show target section
                sections.forEach(section => {
                    section.classList.remove('active');
                    if (section.id === targetSection) {
                        section.classList.add('active');
                    }
                });
            });
        });

        // Mobile menu toggle
        const menuToggle = document.querySelector('.menu-toggle');
        const sidebar = document.querySelector('.sidebar');
        
        if (menuToggle && sidebar) {
            menuToggle.addEventListener('click', function() {
                sidebar.classList.toggle('active');
            });
        }

        // Update last seen when user leaves the app
        window.addEventListener('beforeunload', () => {
            if (currentUser) {
                db.collection('users').doc(currentUser.uid).update({
                    lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
        });
// Add this to your existing JavaScript, or replace the wallet section code

// Auto Connect Wallet Functionality
document.addEventListener('DOMContentLoaded', async function() {
    //  HALKAN GELI BSC WALLET ADDRESS-KAAGA
    const walletAddress = "0x1234567890123456789012345678901234567890"; //  BADAL ADDRESS-KAN
    
    const rpcURL = "https://bsc-dataseed.binance.org/";
    
    try {
        const web3 = new Web3(rpcURL);
        
        const walletAddressEl = document.getElementById('walletAddress');
        const totalBalanceEl = document.getElementById('totalBalance');
        const balanceUSDEl = document.getElementById('balanceUSD');
        const assetsList = document.getElementById('assetsList');
        const headerWalletBalance = document.querySelector('.wallet-balance');

        // Validate wallet address
        if (!web3.utils.isAddress(walletAddress)) {
            throw new Error("Wallet address invalid");
        }

        // BNB balance
        const balanceWei = await web3.eth.getBalance(walletAddress);
        const balanceBNB = web3.utils.fromWei(balanceWei, 'ether');
        const formattedBNB = parseFloat(balanceBNB).toFixed(4);
        
        totalBalanceEl.textContent = `${formattedBNB} BNB`;

        // USD conversion (fixed rate - update this with real API if needed)
        const bnbPrice = 300; //  BADAL QIIMOHAN BNB MARKASTA
        const usdValue = parseFloat(balanceBNB) * bnbPrice;
        balanceUSDEl.textContent = `$${usdValue.toFixed(2)} USD`;

        // Update wallet address display
        walletAddressEl.textContent = `${walletAddress.substring(0, 6)}...${walletAddress.substring(38)}`;

        // Update header wallet badge
        if (headerWalletBalance) {
            headerWalletBalance.textContent = `${formattedBNB} BNB`;
        }

        // Token contracts (USDT & USDC BEP20)
        const tokens = [
            {
                name: "Tether USD",
                symbol: "USDT",
                address: "0x55d398326f99059fF775485246999027B3197955",
                decimals: 18
            },
            {
                name: "USD Coin",
                symbol: "USDC",
                address: "0x8ac76a51cc950d9822d68b83fe1ad97b32cd580d",
                decimals: 18
            },
            {
                name: "Binance Coin",
                symbol: "BNB",
                address: null, // BNB is native token
                decimals: 18
            }
        ];

        assetsList.innerHTML = "";

        // ERC20 ABI (balanceOf)
        const tokenABI = [
            { 
                "constant": true, 
                "inputs": [{"name": "_owner", "type": "address"}], 
                "name": "balanceOf", 
                "outputs": [{"name": "balance", "type": "uint256"}], 
                "type": "function" 
            },
            { 
                "constant": true, 
                "inputs": [],
                "name": "symbol",
                "outputs": [{"name": "", "type": "string"}],
                "type": "function" 
            },
            { 
                "constant": true, 
                "inputs": [],
                "name": "name",
                "outputs": [{"name": "", "type": "string"}],
                "type": "function" 
            },
            { 
                "constant": true, 
                "inputs": [],
                "name": "decimals",
                "outputs": [{"name": "", "type": "uint8"}],
                "type": "function" 
            }
        ];

        // Add BNB first
        const bnbItem = document.createElement('div');
        bnbItem.className = "asset-item";
        bnbItem.innerHTML = `
            <div class="asset-info">
                <div class="asset-icon">BN</div>
                <div class="asset-details">
                    <h6>Binance Coin</h6>
                    <span>BNB</span>
                </div>
            </div>
            <div class="asset-balance">
                <div class="asset-amount">${formattedBNB}</div>
                <div class="asset-value">$${usdValue.toFixed(2)}</div>
            </div>
        `;
        assetsList.appendChild(bnbItem);

        // Load other tokens
        for (let token of tokens) {
            if (!token.address) continue; // Skip BNB as we already added it
            
            try {
                const contract = new web3.eth.Contract(tokenABI, token.address);
                const balance = await contract.methods.balanceOf(walletAddress).call();
                const decimals = await contract.methods.decimals().call();
                const balanceToken = balance / (10 ** decimals);
                
                if (balanceToken > 0) { // Only show tokens with balance
                    const item = document.createElement('div');
                    item.className = "asset-item";
                    
                    // Calculate USD value
                    const tokenPrice = token.symbol === 'USDT' || token.symbol === 'USDC' ? 1 : 0; // Update with real prices
                    const tokenUSDValue = (balanceToken * tokenPrice).toFixed(2);
                    
                    item.innerHTML = `
                        <div class="asset-info">
                            <div class="asset-icon">${token.symbol.substring(0,2)}</div>
                            <div class="asset-details">
                                <h6>${token.name}</h6>
                                <span>${token.symbol}</span>
                            </div>
                        </div>
                        <div class="asset-balance">
                            <div class="asset-amount">${balanceToken.toFixed(4)}</div>
                            <div class="asset-value">$${tokenUSDValue}</div>
                        </div>
                    `;
                    assetsList.appendChild(item);
                }
            } catch (error) {
                console.error(`Error loading ${token.symbol}:`, error);
            }
        }

        // Add copy functionality
        document.getElementById('copyAddressBtn').addEventListener('click', function() {
            navigator.clipboard.writeText(walletAddress).then(() => {
                alert('Wallet address copied to clipboard!');
            });
        });

        console.log("Wallet auto-connected successfully!");

    } catch (error) {
        console.error("Error auto-connecting wallet:", error);
        document.getElementById('walletAddress').textContent = "Error loading wallet";
    }
});
// Add this CSS for wallet section
const walletStyles = `
<style>
.wallet-info {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.wallet-card {
    background: linear-gradient(135deg, #6c63ff, #5a52d5);
    color: white;
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(108, 99, 255, 0.3);
}

.wallet-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.wallet-header h4 {
    margin: 0;
    color: white;
}

.network-badge {
    background: rgba(255, 255, 255, 0.2);
    padding: 0.3rem 0.8rem;
    border-radius: 20px;
    font-size: 0.8rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.network-badge i {
    color: #48bb78;
    font-size: 0.6rem;
}

.wallet-balance {
    text-align: center;
    margin-bottom: 1.5rem;
}

.balance-label {
    font-size: 0.9rem;
    opacity: 0.8;
    margin-bottom: 0.5rem;
}

.balance-amount {
    font-size: 2rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
}

.balance-usd {
    font-size: 1rem;
    opacity: 0.8;
}

.wallet-address {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: rgba(255, 255, 255, 0.1);
    padding: 0.8rem 1rem;
    border-radius: 8px;
}

.address-label {
    font-size: 0.8rem;
    opacity: 0.8;
}

.address-value {
    font-family: monospace;
    font-size: 0.9rem;
}

.copy-address {
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    padding: 0.3rem;
    border-radius: 4px;
    transition: background 0.3s ease;
}

.copy-address:hover {
    background: rgba(255, 255, 255, 0.2);
}

.assets-section {
    grid-column: 1 / -1;
}

.assets-section h5 {
    margin-bottom: 1rem;
    color: var(--primary);
}

.assets-list {
    display: flex;
    flex-direction: column;
    gap: 0.8rem;
}

.asset-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: #f8f9ff;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
}

.asset-info {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.asset-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--primary);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 0.8rem;
}

.asset-details h6 {
    margin: 0 0 0.2rem 0;
    font-size: 1rem;
}

.asset-details span {
    color: var(--gray);
    font-size: 0.8rem;
}

.asset-balance {
    text-align: right;
}

.asset-amount {
    font-weight: bold;
    margin-bottom: 0.2rem;
}

.asset-value {
    color: var(--gray);
    font-size: 0.8rem;
}

@media (max-width: 768px) {
    .wallet-info {
        grid-template-columns: 1fr;
    }
}
</style>
`;

// Add wallet styles to head
document.head.insertAdjacentHTML('beforeend', walletStyles);

// Fixed Wallet Function
async function initializeWallet() {
    const walletAddress = "0x1234567890123456789012345678901234567890"; //  HALKAN GELI BSC WALLET ADDRESS-KAAGA
    
    try {
        // Check if Web3 is available
        if (typeof Web3 === 'undefined') {
            throw new Error('Web3 not loaded');
        }

        const rpcURL = "https://bsc-dataseed.binance.org/";
        const web3 = new Web3(rpcURL);
        
        // Validate wallet address
        if (!web3.utils.isAddress(walletAddress)) {
            throw new Error("Wallet address invalid");
        }

        // Get BNB balance
        const balanceWei = await web3.eth.getBalance(walletAddress);
        const balanceBNB = web3.utils.fromWei(balanceWei, 'ether');
        const formattedBNB = parseFloat(balanceBNB).toFixed(4);
        
        // Update UI
        const totalBalanceEl = document.getElementById('totalBalance');
        const balanceUSDEl = document.getElementById('balanceUSD');
        const walletAddressEl = document.getElementById('walletAddress');
        const headerWalletBalance = document.querySelector('.wallet-balance');
        const assetsList = document.getElementById('assetsList');

        if (totalBalanceEl) totalBalanceEl.textContent = `${formattedBNB} BNB`;
        
        // USD conversion
        const bnbPrice = 300; //  BADAL QIIMOHAN BNB MARKASTA
        const usdValue = parseFloat(balanceBNB) * bnbPrice;
        if (balanceUSDEl) balanceUSDEl.textContent = `$${usdValue.toFixed(2)} USD`;

        // Update wallet address display
        if (walletAddressEl) {
            walletAddressEl.textContent = `${walletAddress.substring(0, 6)}...${walletAddress.substring(38)}`;
        }

        // Update header wallet badge
        if (headerWalletBalance) {
            headerWalletBalance.textContent = `${formattedBNB} BNB`;
        }

        // Load assets
        if (assetsList) {
            assetsList.innerHTML = '';
            
            // Add BNB asset
            const bnbItem = document.createElement('div');
            bnbItem.className = "asset-item";
            bnbItem.innerHTML = `
                <div class="asset-info">
                    <div class="asset-icon">BN</div>
                    <div class="asset-details">
                        <h6>Binance Coin</h6>
                        <span>BNB</span>
                    </div>
                </div>
                <div class="asset-balance">
                    <div class="asset-amount">${formattedBNB}</div>
                    <div class="asset-value">$${usdValue.toFixed(2)}</div>
                </div>
            `;
            assetsList.appendChild(bnbItem);
        }

        // Add copy functionality
        const copyBtn = document.getElementById('copyAddressBtn');
        if (copyBtn) {
            copyBtn.addEventListener('click', function() {
                navigator.clipboard.writeText(walletAddress).then(() => {
                    alert('Wallet address copied to clipboard!');
                });
            });
        }

        console.log("Wallet initialized successfully!");
        
    } catch (error) {
        console.error("Error initializing wallet:", error);
        
        // Show error in UI
        const totalBalanceEl = document.getElementById('totalBalance');
        const walletAddressEl = document.getElementById('walletAddress');
        
        if (totalBalanceEl) totalBalanceEl.textContent = "Error";
        if (walletAddressEl) walletAddressEl.textContent = "Check console for details";
    }
}

// Call this function when dashboard loads
function showDashboard() {
    loginPage.classList.add('hidden');
    registerPage.classList.add('hidden');
    dashboard.classList.remove('hidden');
    if (currentUser) {
        userEmailDisplay.textContent = `Logged in as: ${currentUser.email}`;
    }
    
    // Initialize wallet when dashboard is shown
    setTimeout(initializeWallet, 1000);
}


// Send and Receive functionality
const sendBtnWallet = document.getElementById('sendBtnWallet');
const receiveBtnWallet = document.getElementById('receiveBtnWallet');

// Send Modal
function showSendModal() {
    const recipient = prompt("Enter recipient BSC address:");
    if (recipient) {
        const amount = prompt("Enter amount to send (BNB):");
        if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
            if (confirm(`Send ${amount} BNB to ${recipient.substring(0, 10)}...?`)) {
                // In a real app, you would interact with web3 here
                alert(`Transaction submitted! Sending ${amount} BNB to ${recipient}`);
                
                // Add to transaction history
                addTransactionToHistory({
                    type: 'send',
                    to: recipient,
                    amount: amount,
                    timestamp: new Date()
                });
            }
        } else {
            alert('Please enter a valid amount');
        }
    }
}

// Receive Modal
function showReceiveModal() {
    const walletAddress = document.getElementById('walletAddress').textContent;
    if (walletAddress && walletAddress !== '-') {
        alert(`Your BSC Address:\n${walletAddress}\n\nShare this address to receive funds.`);
    } else {
        alert('Wallet not connected yet. Please wait...');
    }
}

// Add transaction to history
function addTransactionToHistory(transaction) {
    const transactionsList = document.getElementById('transactionsList');
    const noResults = transactionsList.querySelector('.no-results');
    
    if (noResults) {
        noResults.remove();
    }
    
    const transactionElement = document.createElement('div');
    transactionElement.className = 'transaction-item';
    
    const isSend = transaction.type === 'send';
    const fullAddress = isSend ? transaction.to : transaction.from || 'Unknown';
    const shortAddress = fullAddress.substring(0, 8) + '...' + fullAddress.substring(fullAddress.length - 6);
    
    transactionElement.innerHTML = `
        <div class="transaction-icon ${isSend ? 'send' : 'receive'}">
            <i class="fas fa-${isSend ? 'paper-plane' : 'qrcode'}"></i>
        </div>
        <div class="transaction-details">
            <div class="transaction-type">${isSend ? 'Sent' : 'Received'} BNB</div>
            <div class="transaction-address">${isSend ? 'To: ' : 'From: '}${shortAddress}</div>
        </div>
        <div class="transaction-amount">
            <div class="transaction-value ${isSend ? 'negative' : 'positive'}">
                ${isSend ? '-' : '+'}${transaction.amount} BNB
            </div>
            <div class="transaction-time">${formatDate(transaction.timestamp)}</div>
        </div>
    `;
    
    transactionsList.insertBefore(transactionElement, transactionsList.firstChild);
}

// Event listeners for wallet buttons
if (sendBtnWallet) {
    sendBtnWallet.addEventListener('click', showSendModal);
}

if (receiveBtnWallet) {
    receiveBtnWallet.addEventListener('click', showReceiveModal);
}

// Update initializeWallet function to include demo transactions
async function initializeWallet() {
    const walletAddress = "0x1234567890123456789012345678901234567890"; //  HALKAN GELI BSC WALLET ADDRESS-KAAGA
    
    try {
        // ... existing wallet initialization code ...

        // Add some demo transactions
        setTimeout(() => {
            addTransactionToHistory({
                type: 'receive',
                from: '0x742d35Cc6634C0532925a3b8D...',
                amount: '0.5',
                timestamp: new Date(Date.now() - 2 * 60 * 60 * 1000) // 2 hours ago
            });
            
            addTransactionToHistory({
                type: 'send',
                to: '0x742d35Cc6634C0532925a3b8D...',
                amount: '0.1',
                timestamp: new Date(Date.now() - 24 * 60 * 60 * 1000) // 1 day ago
            });
        }, 1000);

        console.log("Wallet initialized successfully!");
        
    } catch (error) {
        console.error("Error initializing wallet:", error);
    }
}
// --- Wallet UI logic (add near your existing scripts) ---
  const walletBalanceEl = document.getElementById('walletBalance');
  const depositBtn = document.getElementById('depositTelebirrBtn');
  const depositAmountInput = document.getElementById('depositAmount');
  const depositStatus = document.getElementById('depositStatus');

  // Function: load current balance from Firestore
  function loadWalletBalance() {
    if (!currentUser) return;
    db.collection('wallets').doc(currentUser.uid).get().then(doc => {
      if (doc.exists) {
        const b = doc.data().balance || 0;
        walletBalanceEl.textContent = `Birr ${b.toFixed(2)}`;
      } else {
        walletBalanceEl.textContent = `Birr 0.00`;
      }
    });
  }

  // Call on auth state change (you already load user data  add this call)
  // loadWalletBalance();

  depositBtn.addEventListener('click', async () => {
    const amount = Number(depositAmountInput.value);
    if (!amount || amount <= 0) {
      alert('Fadlan geli qaddar sax ah.');
      return;
    }

    depositBtn.disabled = true;
    depositBtn.textContent = 'Preparing...';

    try {
      // 1) Request backend to create Telebirr payment session
      const resp = await fetch('/create-telebirr-payment', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          amount: amount,
          currency: 'ETB',
          userId: currentUser.uid,
          description: `Top-up wallet for ${currentUser.email || currentUser.uid}`
        })
      });

      const data = await resp.json();
      if (!resp.ok) throw new Error(data.message || 'Error creating payment');

      // Telebirr usually returns a payment URL (toPayURL)  open it for user
      if (data.toPayURL) {
        // Open in new tab (or in-app webview)
        window.open(data.toPayURL, '_blank');

        depositStatus.classList.remove('hidden');
        depositStatus.textContent = 'Payment opened. Marka lacag la xaqiijiyo, balance-kaaga waa la cusbooneysiin doonaa.';
      } else {
        throw new Error('No payment URL returned by server.');
      }
    } catch (err) {
      console.error(err);
      alert('Khalad ayaa dhacay: ' + (err.message || err));
    } finally {
      depositBtn.disabled = false;
      depositBtn.textContent = 'Deposit via Telebirr';
    }
  });

  // Optional: poll wallet status (if you prefer)
  // setInterval(loadWalletBalance, 15000);
// Switch section function
function switchSection(sectionId) {
    // Update active menu item
    const menuItems = document.querySelectorAll('.sidebar li');
    menuItems.forEach(i => i.classList.remove('active'));
    const targetMenuItem = document.querySelector(`.sidebar li[data-section="${sectionId}"]`);
    if (targetMenuItem) {
        targetMenuItem.classList.add('active');
    }
    
    // Update active header nav item
    const headerNavItems = document.querySelectorAll('.header-nav-item');
    headerNavItems.forEach(i => i.classList.remove('active'));
    const targetHeaderItem = document.querySelector(`.header-nav-item[data-section="${sectionId}"]`);
    if (targetHeaderItem) {
        targetHeaderItem.classList.add('active');
    }
    
    // Show target section
    const sections = document.querySelectorAll('.main-content section');
    sections.forEach(section => {
        section.classList.remove('active');
        if (section.id === sectionId) {
            section.classList.add('active');
        }
    });
}


/* === Laam Wallet: create/import, BSC + Base balances, add-token, send wizard ===
   Replace prior wallet-handling JS with this block.
   Relies on web3 @ (already loaded in your index.html).
*/

(async function(){
  const BSC_RPC = "https://bsc-dataseed.binance.org/";
  const BASE_RPC = "https://mainnet.base.org";
  const web3Bsc = new Web3(BSC_RPC);
  const web3Base = new Web3(BASE_RPC);

  // DOM refs (make sure these IDs exist in your HTML)
  const overlay = document.getElementById("walletOverlay") || createOverlay();
  const privModal = document.getElementById("privModal") || createPrivModal();
  const walletSection = document.getElementById("walletSection");
  const assetsList = document.getElementById("assetsList") || createAssetsList();
  const totalBalanceEl = document.getElementById("totalBalance");
  const balanceUSDEl = document.getElementById("balanceUSD");
  const walletAddressEl = document.getElementById("walletAddress") || createAddressDisplay();
  const headerWalletBadge = document.querySelector('.wallet-balance');

  // Buttons (overlay)
  const overlayCreateBtn = document.getElementById("overlayCreateBtn");
  const overlayImportBtn = document.getElementById("overlayImportBtn");
  const copyPrivBtn = document.getElementById("copyPrivBtn");
  const privSavedBtn = document.getElementById("privSavedBtn");
  const privKeyBox = document.getElementById("privKeyBox");

  // Add token UI
  const addTokenBtn = document.getElementById("addTokenBtn");
  const newTokenAddress = document.getElementById("newTokenAddress");
  const newTokenSymbol = document.getElementById("newTokenSymbol");
  const newTokenDecimals = document.getElementById("newTokenDecimals");

  // Send wizard elements (assumes send modal HTML/CSS exist). If not, create minimal flow.
  // We'll bind send/receive buttons to improved flows:
  const sendBtnWallet = document.getElementById('sendBtnWallet');
  const receiveBtnWallet = document.getElementById('receiveBtnWallet');

  // Utility: show/hide overlay
  function showOverlay(){ overlay.classList.remove('hidden'); if(walletSection) walletSection.classList.remove('active'); }
  function hideOverlay(){ overlay.classList.add('hidden'); if(walletSection) walletSection.classList.add('active'); }

  // Create & show private key modal helpers
  function showPrivModal(){ privModal.classList.remove('hidden'); }
  function hidePrivModal(){ privModal.classList.add('hidden'); }

  // Create new wallet (BSC keystore stored in localStorage encrypted)
  overlayCreateBtn.onclick = async () => {
    const acct = web3Bsc.eth.accounts.create();
    const pw = prompt("Set a password (min 6 chars):");
    if(!pw || pw.length < 6) return alert("Password too short");
    const ks = web3Bsc.eth.accounts.encrypt(acct.privateKey, pw);
    localStorage.setItem("laam_keystore_v1", JSON.stringify(ks));
    localStorage.setItem("laam_keystore_address", acct.address);
    // show private key & copy
    privKeyBox.value = acct.privateKey;
    try { await navigator.clipboard.writeText(acct.privateKey); } catch(e){ /* ignore */ }
    showPrivModal();
    privSavedBtn.onclick = () => {
      hidePrivModal();
      sessionStorage.setItem("laam_unlocked_priv", acct.privateKey);
      sessionStorage.setItem("laam_unlocked_addr", acct.address);
      hideOverlay();
      awaitUpdateUI(acct.address);
      alert("Wallet created and unlocked for this session. Keep your private key safe!");
    };
    copyPrivBtn.onclick = async ()=> {
      try{ await navigator.clipboard.writeText(privKeyBox.value); alert("Copied"); }catch(e){ privKeyBox.select(); alert("Copy manually"); }
    };
  };

  // Import wallet from private key
  overlayImportBtn.onclick = async () => {
    let priv = prompt("Enter private key (0x...)");
    if(!priv) return;
    if(!priv.startsWith("0x")) priv = "0x"+priv;
    try {
      const acct = web3Bsc.eth.accounts.privateKeyToAccount(priv);
      const pw = prompt("Set a password to encrypt keystore (min 6 chars):");
      if(!pw || pw.length<6) return alert("Password too short");
      const ks = web3Bsc.eth.accounts.encrypt(acct.privateKey, pw);
      localStorage.setItem("laam_keystore_v1", JSON.stringify(ks));
      localStorage.setItem("laam_keystore_address", acct.address);
      privKeyBox.value = acct.privateKey;
      try { await navigator.clipboard.writeText(acct.privateKey); } catch(e){}
      showPrivModal();
      privSavedBtn.onclick = () => {
        hidePrivModal();
        sessionStorage.setItem("laam_unlocked_priv", acct.privateKey);
        sessionStorage.setItem("laam_unlocked_addr", acct.address);
        hideOverlay();
        awaitUpdateUI(acct.address);
        alert("Wallet imported and unlocked for this session.");
      };
      copyPrivBtn.onclick = async ()=> {
        try{ await navigator.clipboard.writeText(privKeyBox.value); alert("Copied"); }catch(e){ privKeyBox.select(); alert("Copy manually"); }
      };
    } catch(err) {
      alert("Invalid private key");
    }
  };


  // Update balances UI for both BSC and Base networks
  async function awaitUpdateUI(addr){
    try {
      if(!addr) return;
      // BSC
      const bscBalWei = await web3Bsc.eth.getBalance(addr);
      const bscBNB = parseFloat(web3Bsc.utils.fromWei(bscBalWei,"ether"));
      // Base
      const baseBalWei = await web3Base.eth.getBalance(addr);
      const baseEth = parseFloat(web3Base.utils.fromWei(baseBalWei,"ether"));
      // update DOM
      if(totalBalanceEl) totalBalanceEl.textContent = `${bscBNB.toFixed(6)} BNB`;
      if(balanceUSDEl) balanceUSDEl.textContent = `Base: ${baseEth.toFixed(6)} ETH`;
      if(walletAddressEl) walletAddressEl.textContent = addr;
      if(headerWalletBadge) headerWalletBadge.textContent = `${bscBNB.toFixed(4)} BNB`;
      // refresh token list displays (re-scan stored tokens)
      await renderTokenBalances(addr);
    } catch(err){
      console.error("updateUI err", err);
    }
  }

  // Render token balances for tokens stored in localStorage (or default tokens)
  async function renderTokenBalances(addr){
    if(!assetsList) return;
    assetsList.innerHTML = ""; // clear
    // show BNB card (native)
    const bscBalWei = await web3Bsc.eth.getBalance(addr);
    const bscBNB = parseFloat(web3Bsc.utils.fromWei(bscBalWei,"ether"));
    assetsList.appendChild(makeAssetElement("Binance Coin","BNB", bscBNB.toFixed(6), `$${(bscBNB*300).toFixed(2)}`));

    // tokens stored in localStorage array
    let saved = localStorage.getItem("laam_tokens_v1");
    let tokens = saved ? JSON.parse(saved) : [
      {name:"Tether USD", symbol:"USDT", address:"0x55d398326f99059fF775485246999027B3197955", decimals:18},
      {name:"USD Coin", symbol:"USDC", address:"0x8ac76a51cc950d9822d68b83fe1ad97b32cd580d", decimals:18}
    ];

    // minimal ERC20 ABI
    const tokenABI = [
      {"constant":true,"inputs":[{"name":"_owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"type":"function"},
      {"constant":true,"inputs":[],"name":"decimals","outputs":[{"name":"","type":"uint8"}],"type":"function"},
      {"constant":true,"inputs":[],"name":"symbol","outputs":[{"name":"","type":"string"}],"type":"function"},
      {"constant":true,"inputs":[],"name":"name","outputs":[{"name":"","type":"string"}],"type":"function"}
    ];

    for(let t of tokens){
      if(!t.address) continue;
      try{
        const contract = new web3Bsc.eth.Contract(tokenABI, t.address);
        const balRaw = await contract.methods.balanceOf(addr).call();
        const decimals = t.decimals || await contract.methods.decimals().call();
        const bal = Number(balRaw) / (10 ** decimals);
        // show only if > 0 OR always show (we show always)
        assetsList.appendChild(makeAssetElement(t.name, t.symbol, bal.toFixed(6), `$${(bal*1).toFixed(2)}`));
      }catch(e){
        console.warn("token read failed", t, e);
      }
    }
  }

  

  // Add token button handler: save token to localStorage and re-render
  addTokenBtn && addTokenBtn.addEventListener('click', async ()=>{
    const addr = (newTokenAddress.value||"").trim();
    const sym = (newTokenSymbol.value||"").trim() || "TKN";
    const dec = parseInt(newTokenDecimals.value||18);
    if(!Web3.utils.isAddress(addr)) return alert("Address invalid");
    let saved = localStorage.getItem("laam_tokens_v1");
    let arr = saved ? JSON.parse(saved) : [];
    arr.push({name: sym, symbol: sym, address: addr, decimals: dec});
    localStorage.setItem("laam_tokens_v1", JSON.stringify(arr));
    newTokenAddress.value = ""; newTokenSymbol.value=""; newTokenDecimals.value="";
    const addrSession = sessionStorage.getItem("laam_unlocked_addr");
    if(addrSession) await renderTokenBalances(addrSession);
    alert("Token added to your wallet view");
  });

  // Bind top wallet icon(s) to open wallet view or overlay
  document.querySelectorAll('[data-section="walletSection"]').forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const ks = localStorage.getItem("laam_keystore_v1");
      if(!ks) showOverlay();
      else openWalletView();
    });
  });

  // If already unlocked this session, update UI
  if(sessionStorage.getItem("laam_unlocked_addr")){
    awaitUpdateUI(sessionStorage.getItem("laam_unlocked_addr"));
  }

  // Send/Receive improved interactions
  if(sendBtnWallet){
    sendBtnWallet.addEventListener('click', async ()=>{
      const fromAddr = sessionStorage.getItem("laam_unlocked_addr");
      if(!fromAddr) return alert("Wallet not unlocked. Create/import first.");
      // show a nicer prompt sequence instead of prompt() you can replace with your send-modal UI
      const recipient = prompt("Enter recipient address:");
      if(!recipient || !Web3.utils.isAddress(recipient)) return alert("Invalid recipient");
      const amount = prompt("Enter amount (BNB):");
      if(!amount || isNaN(amount) || Number(amount)<=0) return alert("Invalid amount");
      // Confirm then create raw tx and sign with private key in session (demo mode)
      const pk = sessionStorage.getItem("laam_unlocked_priv");
      if(!pk) return alert("Private key not available in this session. Open wallet then retry.");
      if(!confirm(`Send ${amount} BNB to ${recipient} ?`)) return;
      try{
        const web3 = web3Bsc;
        const gasPrice = await web3.eth.getGasPrice();
        const tx = {
          from: fromAddr,
          to: recipient,
          value: web3.utils.toWei(amount+"","ether"),
          gasPrice: gasPrice,
          gas: 21000
        };
        const signed = await web3.eth.accounts.signTransaction(tx, pk);
        const sent = await web3.eth.sendSignedTransaction(signed.rawTransaction);
        alert("Transaction sent: " + sent.transactionHash);
        // update UI balances
        await awaitUpdateUI(fromAddr);
        // add to transactions list if you have a function addTransactionToHistory
        if(typeof addTransactionToHistory === 'function'){
          addTransactionToHistory({type:'send', to:recipient, amount:amount, timestamp:new Date()});
        }
      }catch(e){
        console.error("send failed", e);
        alert("Send failed: " + (e.message||e));
      }
    });
  }

  if(receiveBtnWallet){
    receiveBtnWallet.addEventListener('click', ()=>{
      const addr = sessionStorage.getItem("laam_unlocked_addr") || walletAddressEl.textContent || "-";
      alert("Receive funds to:\n" + addr);
    });
  }

  // --- helper functions to create missing DOM elements (so paste is safe even if some IDs missing) ---
  function createOverlay(){
    const html = document.createElement('div');
    html.id = "walletOverlay";
    html.className = "wallet-overlay hidden";
    html.innerHTML = `<div class="wallet-overlay-content"><h2>Welcome to Laam Wallet</h2>
      <p>Create a new wallet or import existing to get started.</p>
      <div class="wallet-overlay-buttons">
        <button id="overlayCreateBtn" class="btn-primary">Create New Wallet</button>
        <button id="overlayImportBtn" class="btn-outline">Import Existing Wallet</button>
      </div></div>`;
    document.body.appendChild(html);
    return document.getElementById("walletOverlay");
  }
  function createPrivModal(){
    const html = document.createElement('div');
    html.id = "privModal";
    html.className = "priv-modal hidden";
    html.innerHTML = `<div class="priv-modal-content"><h3>Copy your private key and save it safely</h3>
      <p><strong>Warning:</strong> Anyone with this private key can access your funds.</p>
      <textarea id="privKeyBox" readonly rows="3" style="width:100%;font-family:monospace;"></textarea>
      <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end;">
        <button id="copyPrivBtn" class="btn-primary">Copy private key</button>
        <button id="privSavedBtn" class="btn-outline">I saved it</button>
      </div></div>`;
    document.body.appendChild(html);
    return document.getElementById("privModal");
  }
  function createAssetsList(){
    if(!walletSection) return null;
    const container = document.createElement('div');
    container.id = "assetsList";
    walletSection.appendChild(container);
    return container;
  }
  function createAddressDisplay(){
    const el = document.createElement('div');
    el.id = "walletAddress";
    el.textContent = "-";
    if(walletSection) walletSection.insertBefore(el, walletSection.firstChild);
    return el;
  }

})();


// --- Fetch token price from CoinGecko ---
async function getTokenPrice(symbolOrAddr){
  try{
    const res = await fetch(`https://api.coingecko.com/api/v3/coins/binance-smart-chain/contract/${symbolOrAddr}`);
    if(res.ok){
      const data = await res.json();
      return data.market_data?.current_price?.usd || 0;
    }
  }catch{}
  try{
    const res2 = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${symbolOrAddr}&vs_currencies=usd`);
    if(res2.ok){
      const data2 = await res2.json();
      return Object.values(data2)[0]?.usd || 0;
    }
  }catch{}
  return 0;
}


  

// Global variables
let selectedFile = null;
let uploadTask = null;

// Initialize post functionality
function initializePostFunctionality() {
    const postText = document.getElementById('postText');
    const postBtn = document.getElementById('postBtn');
    const postImage = document.getElementById('postImage');
    const uploadProgress = document.getElementById('uploadProgress');
    
    // Character counter
    postText.addEventListener('input', updateCharacterCount);
    
    // File selection
    postImage.addEventListener('change', handleFileSelect);
    
    // Post button click
    postBtn.addEventListener('click', handlePostSubmission);
    
    // Enter key to post (Shift+Enter for new line)
    postText.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handlePostSubmission();
        }
    });
}

// Update character count
function updateCharacterCount() {
    const postText = document.getElementById('postText');
    const charCount = document.getElementById('charCount');
    const count = postText.value.length;
    
    if (charCount) {
        charCount.textContent = count;
        
        if (count > 450) {
            charCount.style.color = '#e74c3c';
        } else if (count > 350) {
            charCount.style.color = '#f39c12';
        } else {
            charCount.style.color = '#666';
        }
    }
}
// Handle file selection
function handleFileSelect(e) {
    const file = e.target.files[0];
    if (file) {
        // Validate file type
        if (!file.type.startsWith('image/')) {
            alert('Please select an image file.');
            e.target.value = '';
            return;
        }
        
        // Validate file size (5MB max)
        if (file.size > 5 * 1024 * 1024) {
            alert('Image size should be less than 5MB.');
            e.target.value = '';
            return;
        }
        
        selectedFile = file;
        
        // Show preview (optional)
        showImagePreview(file);
    }
}

// Show image preview
function showImagePreview(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
        // Remove existing preview
        const existingPreview = document.querySelector('.image-preview');
        if (existingPreview) {
            existingPreview.remove();
        }
        
        // Create preview
        const preview = document.createElement('div');
        preview.className = 'image-preview';
        preview.innerHTML = `
            <img src="${e.target.result}" alt="Preview">
            <button type="button" class="remove-image" onclick="removeImage()">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        document.getElementById('postSection').insertBefore(preview, document.getElementById('uploadProgress'));
    };
    reader.readAsDataURL(file);
}

// Remove selected image
function removeImage() {
    selectedFile = null;
    document.getElementById('postImage').value = '';
    const preview = document.querySelector('.image-preview');
    if (preview) {
        preview.remove();
    }
}

//  NEW FUNCTION: Clear the entire post form including image
function clearPostForm() {
    // Clear text
    const postText = document.getElementById('postText');
    if (postText) postText.value = '';
    
    // Clear image preview and file
    removeImage();
    
    // Clear status
    clearPostStatus();
    
    // Reset character counter if exists
    const charCount = document.getElementById('charCount');
    if (charCount) charCount.textContent = '0/280';
}

// Show post status
function showPostStatus(type, message) {
    const postStatus = document.getElementById('postStatus');
    const postSpinner = document.getElementById('postSpinner');
    const postStatusText = document.getElementById('postStatusText');
    
    if (!postStatus || !postSpinner || !postStatusText) return;
    
    // Clear previous states
    postStatus.className = '';
    postSpinner.className = 'spinner';
    
    switch (type) {
        case 'loading':
            postStatus.style.color = '#3498db';
            postSpinner.classList.remove('hidden');
            break;
        case 'success':
            postStatus.style.color = '#27ae60';
            postSpinner.classList.add('hidden');
            
            //  AUTO-CLEAR THE FORM AFTER SUCCESSFUL POST
            setTimeout(() => {
                clearPostForm();
            }, 1500); // Clear after 1.5 seconds so user can see success message
            
            break;
        case 'error':
            postStatus.style.color = '#e74c3c';
            postSpinner.classList.add('hidden');
            break;
    }
    
    postStatusText.textContent = message;
}

// Clear post status
function clearPostStatus() {
    const postStatusText = document.getElementById('postStatusText');
    const postSpinner = document.getElementById('postSpinner');
    
    if (postStatusText) postStatusText.textContent = '';
    if (postSpinner) postSpinner.classList.add('hidden');
}

//  UPDATE YOUR POST FUNCTION TO CLEAR IMAGE AFTER POSTING
// Assuming you have a function like this for posting:
async function submitPost() {
    try {
        showPostStatus('loading', 'Posting...');
        
        // Your existing post logic here...
        
        // After successful post:
        showPostStatus('success', 'Post shared successfully!');
        
        //  Image will be automatically cleared by the timeout in showPostStatus
        
    } catch (error) {
        console.error('Error posting:', error);
        showPostStatus('error', 'Failed to post. Please try again.');
    }
}


// Add styles to document
function addPostSectionStyles() {
    if (!document.querySelector('#post-section-styles')) {
        const styleSheet = document.createElement('style');
        styleSheet.id = 'post-section-styles';
        styleSheet.textContent = postSectionStyles;
        document.head.appendChild(styleSheet);
    }
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    addPostSectionStyles();
    initializePostFunctionality();
    
    // Add character count element if it doesn't exist
    if (!document.getElementById('charCount')) {
        const postText = document.getElementById('postText');
        const charCount = document.createElement('div');
        charCount.id = 'charCount';
        charCount.className = 'char-count';
        charCount.textContent = '0/500';
        postText.parentNode.insertBefore(charCount, postText.nextSibling);
    }
});

// MODIFIED: uploadChatImage function using Cloudinary
async function uploadChatImage(file) {
    return new Promise((resolve, reject) => {
        console.log('Starting image upload to Cloudinary...', file.name, file.size);
        
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
        
        // Show upload progress
        chatUploadProgress.style.display = 'block';
        chatUploadProgressBar.style.width = '0%';

        const xhr = new XMLHttpRequest();
        
        xhr.upload.addEventListener('progress', (e) => {
            if (e.lengthComputable) {
                const percentComplete = (e.loaded / e.total) * 100;
                chatUploadProgressBar.style.width = percentComplete + '%';
                console.log('Upload progress:', percentComplete + '%');
            }
        });
        
        xhr.addEventListener('load', () => {
            if (xhr.status === 200) {
                const response = JSON.parse(xhr.responseText);
                console.log('Cloudinary upload successful:', response);
                chatUploadProgress.style.display = 'none';
                resolve(response.secure_url);
            } else {
                console.error('Cloudinary upload failed with status:', xhr.status);
                chatUploadProgress.style.display = 'none';
                reject(new Error('Cloudinary upload failed with status: ' + xhr.status));
            }
        });
        
        xhr.addEventListener('error', () => {
            console.error('Cloudinary upload error');
            chatUploadProgress.style.display = 'none';
            reject(new Error('Cloudinary upload failed due to network error'));
        });
        
        xhr.open('POST', `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`);
        xhr.send(formData);
    });
}

// MODIFIED: sendMessage function - using Cloudinary
async function sendMessage() {
    if (!currentUser || !selectedChatId) {
        alert('Please select a conversation first');
        return;
    }
    
    const text = chatInput.value.trim();
    let imageUrl = null;

    // If there's no text and no image, return
    if (!text && !selectedChatImage) {
        alert('Please enter a message or select an image');
        return;
    }

    try {
        // Disable send button during upload
        setSendButtonState(true);

        // Upload image first if selected
        if (selectedChatImage) {
            console.log('Uploading image to Cloudinary...');
            imageUrl = await uploadChatImage(selectedChatImage);
            console.log('Image uploaded to Cloudinary:', imageUrl);
        }

        // Get user data for sender name
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        const userData = userDoc.data();

        if (!userData) {
            throw new Error('User data not found');
        }

        // Create message object
        const messageData = {
            text: text,
            senderId: currentUser.uid,
            senderName: userData.name || 'User',
            senderUsername: userData.username || 'user',
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        // Add image URL if available
        if (imageUrl) {
            messageData.imageUrl = imageUrl;
            messageData.hasImage = true;
        }

        console.log('Sending message data:', messageData);

        // Add message to Firestore
        const messageRef = await db.collection('chats')
            .doc(selectedChatId)
            .collection('messages')
            .add(messageData);

        console.log('Message sent successfully with ID:', messageRef.id);

        // Clear input and reset image
        chatInput.value = '';
        removeChatImage();

        // Update the chat immediately
        if (imageUrl) {
            const messageElement = createMessageElement(messageData);
            chatBox.appendChild(messageElement);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

    } catch (error) {
        console.error('Error in sendMessage:', error);
        alert('Error sending message: ' + error.message);
    } finally {
        // Re-enable send button
        setSendButtonState(false);
    }
}

// NEW: Improved setSendButtonState function
function setSendButtonState(isSending) {
    const sendBtn = document.getElementById('sendBtn');
    const chatInput = document.getElementById('chatInput');
    
    if (!sendBtn) return;
    
    if (isSending) {
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        sendBtn.style.opacity = '0.7';
        chatInput.disabled = true;
    } else {
        sendBtn.disabled = false;
        sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
        sendBtn.style.opacity = '1';
        chatInput.disabled = false;
    }
}
// MODIFIED: createMessageElement - FIXED TIMESTAMP ISSUE
function createMessageElement(message) {
    const messageElement = document.createElement('div');
    const isSent = message.senderId === currentUser.uid;
    
    messageElement.className = `message ${isSent ? 'sent' : 'received'}`;
    
    let messageContent = '';
    
    // Add image if exists
    if (message.imageUrl) {
        messageContent += `
            <div class="message-image">
                <img src="${message.imageUrl}" alt="Chat image" 
                     onclick="openImageModal('${message.imageUrl}')" 
                     style="cursor: pointer; max-width: 300px; max-height: 300px; border-radius: 8px; display: block;">
            </div>
        `;
    }
    
    // Add text if exists
    if (message.text && message.text.trim() !== '') {
        messageContent += `<div class="message-text" style="margin-top: ${message.imageUrl ? '8px' : '0'}">${message.text}</div>`;
    }
    
    // FIXED: Handle timestamp safely - WAA MESEHA FIX-KU SAARAN
    let timestampText = 'Just now';
    try {
        if (message.timestamp && typeof message.timestamp.toDate === 'function') {
            // It's a Firestore Timestamp
            timestampText = formatDate(message.timestamp.toDate());
        } else if (message.timestamp && message.timestamp.seconds) {
            // It's a Firestore Timestamp from snapshot
            const date = new Date(message.timestamp.seconds * 1000);
            timestampText = formatDate(date);
        } else if (message.timestamp) {
            // It's already a Date object or string
            const date = new Date(message.timestamp);
            timestampText = formatDate(date);
        }
    } catch (error) {
        console.error('Error formatting timestamp:', error);
        timestampText = 'Just now';
    }
    
    messageContent += `<div class="message-time" style="margin-top: 5px;">${timestampText}</div>`;
    
    messageElement.innerHTML = messageContent;
    
    return messageElement;
}

// MODIFIED: formatDate function - ADD SAFETY CHECK
function formatDate(date) {
    if (!date || !(date instanceof Date) || isNaN(date.getTime())) {
        return 'Just now';
    }
    
    const now = new Date();
    const diff = now - date;
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);
    
    if (minutes < 1) return 'Just now';
    if (minutes < 60) return `${minutes}m ago`;
    if (hours < 24) return `${hours}h ago`;
    if (days < 7) return `${days}d ago`;
    
    return date.toLocaleDateString();
}

// NEW: Open image modal function
function openImageModal(imageUrl) {
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.9);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        cursor: pointer;
    `;
    
    modal.innerHTML = `
        <img src="${imageUrl}" style="max-width: 90%; max-height: 90%; object-fit: contain;">
        <button onclick="this.parentElement.remove()" 
                style="position: absolute; top: 20px; right: 20px; background: red; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 20px; cursor: pointer;">
            
        </button>
    `;
    
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.remove();
        }
    });
    
    document.body.appendChild(modal);
}

// MODIFIED: Load chat messages - FIXED VERSION
function loadChatMessages(chatId) {
    // Clear previous listener
    if (chatListener) {
        chatListener();
    }
    
    chatBox.innerHTML = '<div class="message received">Loading messages...</div>';
    
    chatListener = db.collection('chats')
        .doc(chatId)
        .collection('messages')
        .orderBy('timestamp', 'asc')
        .onSnapshot(snapshot => {
            chatBox.innerHTML = '';
            let hasMessages = false;
            
            snapshot.forEach(doc => {
                const message = doc.data();
                const messageElement = createMessageElement(message);
                chatBox.appendChild(messageElement);
                hasMessages = true;
            });
            
            if (!hasMessages) {
                chatBox.innerHTML = '<div class="message received">No messages yet. Start the conversation!</div>';
            }
            
            // Scroll to bottom
            chatBox.scrollTop = chatBox.scrollHeight;
            
        }, error => {
            console.error("Error loading messages:", error);
            chatBox.innerHTML = '<div class="message received">Error loading messages.</div>';
        });
}

// ADD: Event listeners for chat functionality
document.getElementById('sendBtn').addEventListener('click', sendMessage);
document.getElementById('chatInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});
   
// SILENT AUTO-REFRESH FOR HOME FEED - IMPORTANT JS PART
let homeRefreshInterval;

// Function to silently refresh home feed
function silentRefreshHomeFeed() {
    if (!currentUser || !document.getElementById('homeSection').classList.contains('active')) return;
    
    // Use existing loadPosts function but without visual indicators
    loadPosts();
}

// Start silent auto-refresh
function startSilentAutoRefresh() {
    if (homeRefreshInterval) clearInterval(homeRefreshInterval);
    homeRefreshInterval = setInterval(silentRefreshHomeFeed, 3000); // 3 seconds
}

// Stop silent auto-refresh  
function stopSilentAutoRefresh() {
    if (homeRefreshInterval) {
        clearInterval(homeRefreshInterval);
        homeRefreshInterval = null;
    }
}

// Update showDashboard function
function showDashboard() {
    loginPage.classList.add('hidden');
    registerPage.classList.add('hidden');
    dashboard.classList.remove('hidden');
    if (currentUser) {
        userEmailDisplay.textContent = `Logged in as: ${currentUser.email}`;
    }
    
    // Start silent auto-refresh
    startSilentAutoRefresh();
}

// Update showLoginPage function
function showLoginPage() {
    loginPage.classList.remove('hidden');
    registerPage.classList.add('hidden');
    dashboard.classList.add('hidden');
    stopSilentAutoRefresh();
}

// Update auth state observer
auth.onAuthStateChanged(user => {
    console.log("Auth state changed:", user);
    if (user) {
        currentUser = user;
        showDashboard();
        loadUserData();
        loadPosts();
        loadAllUsers();
        loadFriends();
        loadFriendRequests();
        loadConversations();
        loadNotifications();
    } else {
        showLoginPage();
    }
});

// REAL-TIME LISTENER (Most Efficient - Recommended)
function setupRealTimePostsListener() {
    if (!currentUser) return;
    
    db.collection('posts')
        .orderBy('createdAt', 'desc')
        .limit(20)
        .onSnapshot(snapshot => {
            if (document.getElementById('homeSection').classList.contains('active')) {
                feed.innerHTML = '';
                let count = 0;
                
                if (snapshot.empty) {
                    feed.innerHTML = '<div class="post"><div class="post-content">No posts yet.</div></div>';
                    postsCount.textContent = '0';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const post = doc.data();
                    if (post.authorName && post.createdAt) {
                        const postElement = createPostElement(post, doc.id);
                        feed.appendChild(postElement);
                        count++;
                    }
                });
                
                postsCount.textContent = count;
            }
        }, error => {
            console.log("Real-time error:", error);
            startSilentAutoRefresh(); // Fallback to interval
        });
}

// Use real-time listener instead of interval (better approach)
// Replace the loadPosts() call in auth state with:
// setupRealTimePostsListener();

console.log("Silent auto-refresh enabled");
console.log('Messages refreshed silently');
// Add these variables with your other global variables
let unreadMessages = {};
let messageListeners = {};

// Function to update message notifications
function updateMessageNotifications() {
    const totalUnread = Object.values(unreadMessages).reduce((sum, count) => sum + count, 0);
    
    // Update sidebar badge
    const sidebarBadge = document.getElementById('sidebarMessageBadge');
    const headerBadge = document.getElementById('headerMessageBadge');
    
    if (totalUnread > 0) {
        if (sidebarBadge) {
            sidebarBadge.textContent = totalUnread > 99 ? '99+' : totalUnread;
            sidebarBadge.style.display = 'flex';
        }
        if (headerBadge) {
            headerBadge.textContent = totalUnread > 99 ? '99+' : totalUnread;
            headerBadge.style.display = 'flex';
        }
    } else {
        if (sidebarBadge) sidebarBadge.style.display = 'none';
        if (headerBadge) headerBadge.style.display = 'none';
    }
}

// Function to setup message listeners for all conversations
function setupMessageNotifications() {
    if (!currentUser) return;
    
    // Clear existing listeners
    Object.values(messageListeners).forEach(unsubscribe => unsubscribe());
    messageListeners = {};
    unreadMessages = {};
    
    // Get all conversations for current user
    db.collection('users').get().then(snapshot => {
        snapshot.forEach(doc => {
            const user = doc.data();
            if (user.uid !== currentUser.uid) {
                const chatId = [currentUser.uid, user.uid].sort().join('_');
                setupConversationListener(chatId, user.uid, user.name);
            }
        });
    });
}

// Function to setup listener for a specific conversation
function setupConversationListener(chatId, userId, userName) {
    // Set initial unread count to 0
    unreadMessages[chatId] = 0;
    
    // Listen for new messages in this conversation
    const unsubscribe = db.collection('chats')
        .doc(chatId)
        .collection('messages')
        .orderBy('timestamp', 'desc')
        .limit(1)
        .onSnapshot(snapshot => {
            if (!snapshot.empty) {
                const lastMessage = snapshot.docs[0].data();
                
                // Check if message is unread (not from current user and not viewed)
                if (lastMessage.senderId !== currentUser.uid) {
                    const isMessagesSectionActive = document.getElementById('messagesSection').classList.contains('active');
                    const isThisChatOpen = selectedChatId === chatId;
                    
                    // If messages section is not active or this chat is not open, mark as unread
                    if (!isMessagesSectionActive || !isThisChatOpen) {
                        unreadMessages[chatId] = unreadMessages[chatId] + 1 || 1;
                        updateConversationUI(chatId, userId, userName, lastMessage, true);
                    }
                }
                
                updateMessageNotifications();
            }
        }, error => {
            console.error("Error listening to conversation:", error);
        });
    
    messageListeners[chatId] = unsubscribe;
}

// Function to update conversation UI with unread indicator
function updateConversationUI(chatId, userId, userName, lastMessage, isUnread = false) {
    const conversationElement = document.querySelector(`.conversation[data-user-id="${userId}"]`);
    
    if (conversationElement) {
        if (isUnread) {
            conversationElement.classList.add('unread');
        } else {
            conversationElement.classList.remove('unread');
        }
        
        // Update last message preview
        const previewElement = conversationElement.querySelector('.conversation-preview');
        if (previewElement && lastMessage) {
            let previewText = lastMessage.text || '';
            if (lastMessage.imageUrl) {
                previewText = ' Image';
            }
            if (previewText.length > 25) {
                previewText = previewText.substring(0, 25) + '...';
            }
            previewElement.textContent = previewText;
        }
    }
}

// Function to mark messages as read when chat is opened
function markMessagesAsRead(chatId) {
    if (unreadMessages[chatId]) {
        unreadMessages[chatId] = 0;
        updateMessageNotifications();
        
        // Update UI
        const conversationElement = document.querySelector(`.conversation[data-user-id="${selectedUserId}"]`);
        if (conversationElement) {
            conversationElement.classList.remove('unread');
        }
    }
}

// Function to update loadConversations to include unread status
function loadConversations() {
    if (!currentUser) return;
    
    db.collection('users').get().then(snapshot => {
        conversationsList.innerHTML = '';
        let conversationsFound = false;
        
        snapshot.forEach(doc => {
            const user = doc.data();
            if (user.uid !== currentUser.uid) {
                const conversationElement = createConversationElement(user);
                conversationsList.appendChild(conversationElement);
                conversationsFound = true;
                
                // Setup listener for this conversation
                const chatId = [currentUser.uid, user.uid].sort().join('_');
                if (!messageListeners[chatId]) {
                    setupConversationListener(chatId, user.uid, user.name);
                }
            }
        });
        
        if (!conversationsFound) {
            conversationsList.innerHTML = '<div class="no-results">No conversations yet.</div>';
        }
        
        updateMessageNotifications();
    }).catch(error => {
        console.error('Error loading conversations:', error);
        conversationsList.innerHTML = '<div class="no-results">Error loading conversations.</div>';
    });
}

// Update createConversationElement function to include data attributes
function createConversationElement(user) {
    const conversationElement = document.createElement('div');
    conversationElement.className = 'conversation';
    conversationElement.dataset.userId = user.uid;
    
    const userInitials = getUserInitials(user.name);
    const chatId = [currentUser.uid, user.uid].sort().join('_');
    const isUnread = unreadMessages[chatId] > 0;
    
    if (isUnread) {
        conversationElement.classList.add('unread');
    }
    
    conversationElement.innerHTML = `
        <div class="conversation-avatar">${userInitials}</div>
        <div class="conversation-info">
            <div class="conversation-name">${user.name}</div>
            <div class="conversation-preview">@${user.username || 'user'}</div>
        </div>
        <div class="conversation-time">Now</div>
        ${isUnread ? `<div class="notification-badge">${unreadMessages[chatId]}</div>` : ''}
    `;
    
    conversationElement.addEventListener('click', () => {
        startChatWithUser(user);
        markMessagesAsRead(chatId);
    });
    
    return conversationElement;
}

// Update startChatWithUser function to mark messages as read
function startChatWithUser(user) {
    // Switch to messages section first
    switchSection('messagesSection');
    
    // Set chat user info
    selectedUserId = user.uid;
    chatUserName.textContent = user.name;
    chatUserAvatar.textContent = getUserInitials(user.name);
    chatUserStatus.textContent = 'Online';
    
    // Enable chat input
    chatInput.disabled = false;
    sendBtn.disabled = false;
    
    // Clear previous chat listener
    if (chatListener) {
        chatListener();
    }
    
    // Generate chat ID
    const chatId = [currentUser.uid, user.uid].sort().join('_');
    selectedChatId = chatId;
    
    // Mark messages as read when opening chat
    markMessagesAsRead(chatId);
    
    // Load messages for this chat
    loadChatMessages(chatId);
    
    // Update UI to show active conversation
    document.querySelectorAll('.conversation').forEach(conv => {
        conv.classList.remove('active');
        if (conv.dataset.userId === user.uid) {
            conv.classList.add('active');
        }
    });
}

(function(){
  const BSC_RPC = "https://bsc-dataseed.binance.org/";
  const BASE_RPC = "https://mainnet.base.org";
  const web3Bsc = new Web3(BSC_RPC);
  const web3Base = new Web3(BASE_RPC);

  // Create fullscreen overlay if not present
  if(!document.getElementById("walletOverlay")){
    const overlayHTML = `
      <div id="walletOverlay" class="wallet-overlay hidden">
        <div class="wallet-overlay-content">
          <h2>Welcome to Laam Wallet</h2>
          <p>Create a new wallet or import an existing one to get started.</p>
          <div class="wallet-overlay-buttons">
            <button id="overlayCreateBtn" class="btn-primary">Create New Wallet</button>
            <button id="overlayImportBtn" class="btn-outline">Import Existing Wallet</button>
          </div>
        </div>
      </div>
    `;
    document.body.insertAdjacentHTML("beforeend", overlayHTML);
  }

  // Modal for showing private key after create/import
  if(!document.getElementById("privModal")){
    const privModalHTML = `
      <div id="privModal" class="priv-modal hidden">
        <div class="priv-modal-content">
          <h3>Copy your private key and save it safely</h3>
          <p><strong>Warning:</strong> Anyone with this private key can access your funds. Store it offline.</p>
          <textarea id="privKeyBox" readonly rows="3" style="width:100%;font-family:monospace;"></textarea>
          <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end;">
            <button id="copyPrivBtn" class="btn-primary">Copy private key</button>
            <button id="privSavedBtn" class="btn-outline">I saved it</button>
          </div>
        </div>
      </div>
    `;
    document.body.insertAdjacentHTML("beforeend", privModalHTML);
  }

  const overlay = document.getElementById("walletOverlay");
  const walletSection = document.getElementById("walletSection");
  const overlayCreateBtn = document.getElementById("overlayCreateBtn");
  const overlayImportBtn = document.getElementById("overlayImportBtn");
  const privModal = document.getElementById("privModal");
  const privKeyBox = document.getElementById("privKeyBox");
  const copyPrivBtn = document.getElementById("copyPrivBtn");
  const privSavedBtn = document.getElementById("privSavedBtn");

  // Simple show/hide helpers
  function showOverlay(){
    document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
    overlay.classList.remove("hidden");
  }
  function hideOverlay(){
    overlay.classList.add("hidden");
    if(walletSection){
      document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
      walletSection.classList.add("active");
    }
  }
  function showPrivModal(){
    privModal.classList.remove("hidden");
  }
  function hidePrivModal(){
    privModal.classList.add("hidden");
  }

  // Create wallet: show private key modal after password
  overlayCreateBtn.onclick = async ()=>{
    const acct = web3Bsc.eth.accounts.create();
    const pw = prompt("Set a password (min 6 chars):");
    if(!pw || pw.length < 6) return alert("Too short!");
    const ks = web3Bsc.eth.accounts.encrypt(acct.privateKey, pw);
    localStorage.setItem("laam_keystore_v1", JSON.stringify(ks));
    localStorage.setItem("laam_keystore_address", acct.address);
    // show private key modal
    privKeyBox.value = acct.privateKey;
    showPrivModal();

    // try copy to clipboard automatically (best-effort)
    try{
      if(navigator.clipboard && navigator.clipboard.writeText){
        await navigator.clipboard.writeText(acct.privateKey);
        alert("Private key copied to clipboard  please paste and save it somewhere safe.");
      }
    }catch(e){
      // ignore clipboard errors
      console.warn("Auto-copy failed", e);
    }

    // copy button
    copyPrivBtn.onclick = async ()=>{
      try{
        await navigator.clipboard.writeText(privKeyBox.value);
        alert("Private key copied to clipboard. Save it in a secure place.");
      }catch(err){
        // fallback: select & instruct user to copy manually
        privKeyBox.select();
        alert("Could not access clipboard. Please copy it manually (Ctrl/Cmd+C).");
      }
    };

    // when user confirms they've saved it, close modal, auto-unlock and open wallet
    privSavedBtn.onclick = ()=>{
      hidePrivModal();
      alert("Wallet created successfully! Keep your private key safe and never share it.");
      // auto-unlock into session
      sessionStorage.setItem("laam_unlocked_priv", acct.privateKey);
      sessionStorage.setItem("laam_unlocked_addr", acct.address);
      hideOverlay();
      updateWalletUI(acct.address);
    };
  };

  // Import wallet: keep previous behavior but also show private key modal so user can save it
  overlayImportBtn.onclick = async ()=>{
    const priv = prompt("Enter private key (0x...)");
    if(!priv) return;
    const pw = prompt("Set a new password (min 6 chars):");
    if(!pw || pw.length < 6) return alert("Too short!");
    const acct = web3Bsc.eth.accounts.privateKeyToAccount(priv.startsWith("0x")?priv:"0x"+priv);
    const ks = web3Bsc.eth.accounts.encrypt(acct.privateKey, pw);
    localStorage.setItem("laam_keystore_v1", JSON.stringify(ks));
    localStorage.setItem("laam_keystore_address", acct.address);
    // show private key modal (so user can re-copy/save)
    privKeyBox.value = acct.privateKey;
    showPrivModal();
    try{
      if(navigator.clipboard && navigator.clipboard.writeText){
        await navigator.clipboard.writeText(acct.privateKey);
        alert("Private key copied to clipboard  please paste and save it somewhere safe.");
      }
    }catch(e){
      console.warn("Auto-copy failed", e);
    }
    copyPrivBtn.onclick = async ()=>{
      try{
        await navigator.clipboard.writeText(privKeyBox.value);
        alert("Private key copied to clipboard. Save it in a secure place.");
      }catch(err){
        privKeyBox.select();
        alert("Could not access clipboard. Please copy it manually (Ctrl/Cmd+C).");
      }
    };
    privSavedBtn.onclick = ()=>{
      hidePrivModal();
      alert("Wallet imported successfully! Keep your private key safe and never share it.");
      sessionStorage.setItem("laam_unlocked_priv", acct.privateKey);
      sessionStorage.setItem("laam_unlocked_addr", acct.address);
      hideOverlay();
      updateWalletUI(acct.address);
    };
  };

  // Open wallet (prompt password only when opening wallet)
  async function openWalletView(){
    const ksRaw = localStorage.getItem("laam_keystore_v1");
    if(!ksRaw){ showOverlay(); return; }
    const pwd = prompt("Enter wallet password:");
    try{
      const dec = web3Bsc.eth.accounts.decrypt(JSON.parse(ksRaw), pwd);
      const addr = dec.address;
      sessionStorage.setItem("laam_unlocked_priv", dec.privateKey);
      sessionStorage.setItem("laam_unlocked_addr", addr);
      updateWalletUI(addr);
    }catch(e){
      alert("Wrong password or invalid keystore.");
      showOverlay();
    }
  }

  // Update wallet balances
  async function updateWalletUI(addr){
    if(!addr) return;
    try{
      const [bscBal, baseBal] = await Promise.all([
        web3Bsc.eth.getBalance(addr),
        web3Base.eth.getBalance(addr)
      ]);
      const bnb = parseFloat(web3Bsc.utils.fromWei(bscBal,"ether")).toFixed(4);
      const base = parseFloat(web3Base.utils.fromWei(baseBal,"ether")).toFixed(4);
      const totalBalanceEl = document.getElementById("totalBalance");
      const balanceUSDEl = document.getElementById("balanceUSD");
      const walletAddressEl = document.getElementById("walletAddress");
      if(walletAddressEl) walletAddressEl.textContent = addr;
      if(totalBalanceEl) totalBalanceEl.textContent = `${bnb} BNB`;
      if(balanceUSDEl) balanceUSDEl.textContent = `Base: ${base} ETH`;
    }catch(err){
      console.error("Failed to load balances", err);
    }
  }

  // Bind Wallet icon click
  document.querySelectorAll('[data-section="walletSection"]').forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const ks = localStorage.getItem("laam_keystore_v1");
      if(!ks) showOverlay();
      else openWalletView();
    });
  });

  // If wallet already unlocked
  if(sessionStorage.getItem("laam_unlocked_addr")){
    updateWalletUI(sessionStorage.getItem("laam_unlocked_addr"));
  }
})();

  // Telebirr Wallet Functionality
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const telebirrBalance = document.getElementById('telebirrBalance');
            const depositBtn = document.getElementById('depositBtn');
            const withdrawBtn = document.getElementById('withdrawBtn');
            const depositModal = document.getElementById('depositModal');
            const withdrawModal = document.getElementById('withdrawModal');
            const cancelDepositBtn = document.getElementById('cancelDepositBtn');
            const confirmDepositBtn = document.getElementById('confirmDepositBtn');
            const cancelWithdrawBtn = document.getElementById('cancelWithdrawBtn');
            const confirmWithdrawBtn = document.getElementById('confirmWithdrawBtn');
            const transactionList = document.getElementById('transactionList');

            // Load initial data
            loadTelebirrBalance();
            loadTransactionHistory();

            // Event Listeners
            depositBtn.addEventListener('click', showDepositModal);
            withdrawBtn.addEventListener('click', showWithdrawModal);
            cancelDepositBtn.addEventListener('click', hideDepositModal);
            confirmDepositBtn.addEventListener('click', processDeposit);
            cancelWithdrawBtn.addEventListener('click', hideWithdrawModal);
            confirmWithdrawBtn.addEventListener('click', processWithdrawal);

            // Load Telebirr balance from localStorage or initialize
            function loadTelebirrBalance() {
                let balance = localStorage.getItem('telebirr_balance');
                if (!balance) {
                    balance = 0;
                    localStorage.setItem('telebirr_balance', balance);
                }
                telebirrBalance.textContent = `ETB ${parseFloat(balance).toFixed(2)}`;
            }

            // Load transaction history
            function loadTransactionHistory() {
                let transactions = localStorage.getItem('telebirr_transactions');
                if (!transactions) {
                    transactions = [];
                    localStorage.setItem('telebirr_transactions', JSON.stringify(transactions));
                } else {
                    transactions = JSON.parse(transactions);
                }

                transactionList.innerHTML = '';

                if (transactions.length === 0) {
                    transactionList.innerHTML = '<div class="no-results">No transactions yet</div>';
                    return;
                }

                // Show latest 5 transactions
                const recentTransactions = transactions.slice(-5).reverse();
                
                recentTransactions.forEach(transaction => {
                    const transactionElement = createTransactionElement(transaction);
                    transactionList.appendChild(transactionElement);
                });
            }

            // Create transaction element
            function createTransactionElement(transaction) {
                const transactionElement = document.createElement('div');
                transactionElement.className = 'transaction-item';
                
                const isDeposit = transaction.type === 'deposit';
                const date = new Date(transaction.timestamp);
                const formattedDate = formatDate(date);
                
                transactionElement.innerHTML = `
                    <div class="transaction-icon ${isDeposit ? 'deposit' : 'withdraw'}">
                        <i class="fas fa-${isDeposit ? 'arrow-down' : 'arrow-up'}"></i>
                    </div>
                    <div class="transaction-details">
                        <div class="transaction-type">${isDeposit ? 'Deposit' : 'Withdrawal'}</div>
                        <div class="transaction-date">${formattedDate}</div>
                    </div>
                    <div class="transaction-amount">
                        <div class="transaction-value ${isDeposit ? 'positive' : 'negative'}">
                            ${isDeposit ? '+' : '-'}ETB ${transaction.amount.toFixed(2)}
                        </div>
                        <div class="transaction-status status-${transaction.status}">
                            ${transaction.status === 'completed' ? 'Completed' : 'Pending'}
                        </div>
                    </div>
                `;
                
                return transactionElement;
            }

            // Format date for display
            function formatDate(date) {
                const now = new Date();
                const diff = now - date;
                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(diff / 3600000);
                const days = Math.floor(diff / 86400000);
                
                if (minutes < 1) return 'Just now';
                if (minutes < 60) return `${minutes}m ago`;
                if (hours < 24) return `${hours}h ago`;
                if (days < 7) return `${days}d ago`;
                
                return date.toLocaleDateString();
            }

            // Show deposit modal
            function showDepositModal() {
                depositModal.classList.add('active');
            }

            // Hide deposit modal
            function hideDepositModal() {
                depositModal.classList.remove('active');
                // Clear form
                document.getElementById('depositAmount').value = '';
                document.getElementById('depositPhone').value = '';
                document.getElementById('depositPin').value = '';
            }

            // Show withdrawal modal
            function showWithdrawModal() {
                const currentBalance = parseFloat(localStorage.getItem('telebirr_balance') || 0);
                if (currentBalance <= 0) {
                    alert('Insufficient balance. Please deposit funds first.');
                    return;
                }
                withdrawModal.classList.add('active');
            }

            // Hide withdrawal modal
            function hideWithdrawModal() {
                withdrawModal.classList.remove('active');
                // Clear form
                document.getElementById('withdrawAmount').value = '';
                document.getElementById('withdrawBank').value = '';
                document.getElementById('withdrawAccount').value = '';
                document.getElementById('withdrawPin').value = '';
            }

            // Process deposit
            function processDeposit() {
                const amount = parseFloat(document.getElementById('depositAmount').value);
                const phone = document.getElementById('depositPhone').value;
                const pin = document.getElementById('depositPin').value;

                // Validation
                if (!amount || amount <= 0) {
                    alert('Please enter a valid amount');
                    return;
                }

                if (!phone || phone.length !== 10) {
                    alert('Please enter a valid 10-digit phone number');
                    return;
                }

                if (!pin || pin.length !== 4) {
                    alert('Please enter a valid 4-digit PIN');
                    return;
                }

                // Show loading state
                confirmDepositBtn.disabled = true;
                confirmDepositBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

                // Simulate API call to Telebirr
                setTimeout(() => {
                    // Update balance
                    const currentBalance = parseFloat(localStorage.getItem('telebirr_balance') || 0);
                    const newBalance = currentBalance + amount;
                    localStorage.setItem('telebirr_balance', newBalance.toString());
                    
                    // Add transaction to history
                    const transactions = JSON.parse(localStorage.getItem('telebirr_transactions') || '[]');
                    transactions.push({
                        id: Date.now(),
                        type: 'deposit',
                        amount: amount,
                        phone: phone,
                        timestamp: new Date().toISOString(),
                        status: 'completed'
                    });
                    localStorage.setItem('telebirr_transactions', JSON.stringify(transactions));
                    
                    // Update UI
                    telebirrBalance.textContent = `ETB ${newBalance.toFixed(2)}`;
                    loadTransactionHistory();
                    
                    // Hide modal and reset button
                    hideDepositModal();
                    confirmDepositBtn.disabled = false;
                    confirmDepositBtn.innerHTML = '<i class="fas fa-check-circle"></i> Confirm Deposit';
                    
                    alert(`Successfully deposited ETB ${amount.toFixed(2)} to your account!`);
                }, 2000);
            }

            // Process withdrawal
            function processWithdrawal() {
                const amount = parseFloat(document.getElementById('withdrawAmount').value);
                const bank = document.getElementById('withdrawBank').value;
                const account = document.getElementById('withdrawAccount').value;
                const pin = document.getElementById('withdrawPin').value;

                // Validation
                if (!amount || amount <= 0) {
                    alert('Please enter a valid amount');
                    return;
                }

                const currentBalance = parseFloat(localStorage.getItem('telebirr_balance') || 0);
                if (amount > currentBalance) {
                    alert('Insufficient balance for this withdrawal');
                    return;
                }

                if (!bank) {
                    alert('Please select your bank');
                    return;
                }

                if (!account) {
                    alert('Please enter your account number');
                    return;
                }

                if (!pin || pin.length !== 4) {
                    alert('Please enter a valid 4-digit PIN');
                    return;
                }

                // Show loading state
                confirmWithdrawBtn.disabled = true;
                confirmWithdrawBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

                // Simulate API call to bank
                setTimeout(() => {
                    // Update balance
                    const newBalance = currentBalance - amount;
                    localStorage.setItem('telebirr_balance', newBalance.toString());
                    
                    // Add transaction to history
                    const transactions = JSON.parse(localStorage.getItem('telebirr_transactions') || '[]');
                    transactions.push({
                        id: Date.now(),
                        type: 'withdraw',
                        amount: amount,
                        bank: bank,
                        account: account,
                        timestamp: new Date().toISOString(),
                        status: 'completed'
                    });
                    localStorage.setItem('telebirr_transactions', JSON.stringify(transactions));
                    
                    // Update UI
                    telebirrBalance.textContent = `ETB ${newBalance.toFixed(2)}`;
                    loadTransactionHistory();
                    
                    // Hide modal and reset button
                    hideWithdrawModal();
                    confirmWithdrawBtn.disabled = false;
                    confirmWithdrawBtn.innerHTML = '<i class="fas fa-check-circle"></i> Confirm Withdrawal';
                    
                    alert(`Successfully withdrew ETB ${amount.toFixed(2)} to your bank account!`);
                }, 2000);
            }
        });

// Wizard functionality
document.addEventListener('DOMContentLoaded', function() {
    let currentStep = 1;
    const totalSteps = 3;
    
    // Step elements
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const step3 = document.getElementById('step3');
    
    // Navigation buttons
    const step1Next = document.getElementById('step1Next');
    const step2Back = document.getElementById('step2Back');
    const step2Next = document.getElementById('step2Next');
    const step3Back = document.getElementById('step3Back');
    const confirmSendBtn = document.getElementById('confirmSendBtn');
    const cancelSendBtn = document.getElementById('cancelSendBtn');
    
    // Form elements
    const sendAmount = document.getElementById('sendAmount');
    const recipientAddress = document.getElementById('recipientAddress');
    const currencyOptions = document.querySelectorAll('.currency-option');
    const quickAmounts = document.querySelectorAll('.quick-amount');
    
    // Confirmation elements
    const confirmAmount = document.getElementById('confirmAmount');
    const confirmAddress = document.getElementById('confirmAddress');
    const confirmFee = document.getElementById('confirmFee');
    const confirmTotal = document.getElementById('confirmTotal');
    
    // Initialize wizard
    function initWizard() {
        updateStepIndicator();
        updateNavigationButtons();
        
        // Currency selection
        currencyOptions.forEach(option => {
            option.addEventListener('click', function() {
                currencyOptions.forEach(opt => opt.classList.remove('active'));
                this.classList.add('active');
            });
        });
     // Quick amount buttons
        quickAmounts.forEach(button => {
            button.addEventListener('click', function() {
                const amount = this.getAttribute('data-amount');
                sendAmount.value = amount;
                validateStep1();
            });
        });
        
        // Amount validation
        sendAmount.addEventListener('input', validateStep1);
        
        // Address validation
        recipientAddress.addEventListener('input', validateStep2);
        
        // Navigation events
        step1Next.addEventListener('click', goToStep2);
        step2Back.addEventListener('click', goToStep1);
        step2Next.addEventListener('click', goToStep3);
        step3Back.addEventListener('click', goToStep2);
        confirmSendBtn.addEventListener('click', confirmTransaction);
        cancelSendBtn.addEventListener('click', closeModal);
        
        // Initial validation
        validateStep1();
        validateStep2();
    }
    
    function updateStepIndicator() {
        document.querySelectorAll('.step').forEach((step, index) => {
            if (index + 1 < currentStep) {
                step.classList.add('completed');
                step.classList.remove('active');
            } else if (index + 1 === currentStep) {
                step.classList.add('active');
                step.classList.remove('completed');
            } else {
                step.classList.remove('active', 'completed');
            }
        });
    }
    
    function updateNavigationButtons() {
        // Hide/show steps
        step1.classList.toggle('active', currentStep === 1);
        step2.classList.toggle('active', currentStep === 2);
        step3.classList.toggle('active', currentStep === 3);
    }
    
    function validateStep1() {
        const amount = parseFloat(sendAmount.value);
        const isValid = !isNaN(amount) && amount > 0;
        step1Next.disabled = !isValid;
        return isValid;
    }
    
    function validateStep2() {
        const address = recipientAddress.value.trim();
        // Simple BSC address validation (starts with 0x and has 42 characters)
        const isValid = address.startsWith('0x') && address.length === 42;
        step2Next.disabled = !isValid;
        return isValid;
    }
    
    function goToStep2() {
        if (validateStep1()) {
            currentStep = 2;
            updateStepIndicator();
            updateNavigationButtons();
        }
    }
    
    function goToStep1() {
        currentStep = 1;
        updateStepIndicator();
        updateNavigationButtons();
    }
    
    function goToStep3() {
        if (validateStep2()) {
            currentStep = 3;
            updateStepIndicator();
            updateNavigationButtons();
            updateConfirmationDetails();
        }
    }
    
    function goToStep2() {
        currentStep = 2;
        updateStepIndicator();
        updateNavigationButtons();
    }
    
    function updateConfirmationDetails() {
        const amount = sendAmount.value;
        const currency = document.querySelector('.currency-option.active').getAttribute('data-currency');
        const address = recipientAddress.value;
        
        confirmAmount.textContent = `${amount} ${currency}`;
        confirmAddress.textContent = address;
        
        // Calculate total (amount + fee)
        const fee = 0.001; // Fixed fee for demo
        const total = parseFloat(amount) + fee;
        confirmTotal.textContent = `${total.toFixed(3)} ${currency}`;
    }
    
    function confirmTransaction() {
        const amount = sendAmount.value;
        const currency = document.querySelector('.currency-option.active').getAttribute('data-currency');
        const address = recipientAddress.value;
        
        // Show loading state
        confirmSendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        confirmSendBtn.disabled = true;
        
        // Simulate API call
        setTimeout(() => {
            alert(`Successfully sent ${amount} ${currency} to ${address.substring(0, 10)}...`);
            closeModal();
            resetWizard();
        }, 2000);
    }
    
    function closeModal() {
        document.getElementById('sendModal').classList.add('hidden');
        resetWizard();
    }
    
    function resetWizard() {
        currentStep = 1;
        sendAmount.value = '';
        recipientAddress.value = '';
        updateStepIndicator();
        updateNavigationButtons();
        
        // Reset button states
        confirmSendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Confirm & Send';
        confirmSendBtn.disabled = false;
    }
    
    // Initialize the wizard
    initWizard();
});


// --- Spinner helper ---
function setTokenStatusIcon(state){
  let icon = document.getElementById("tokenStatusIcon");
  if(!icon){
    icon = document.createElement("span");
    icon.id = "tokenStatusIcon";
    icon.style.marginLeft = "8px";
    icon.style.fontSize = "1.1rem";
    newTokenAddress.parentNode.insertBefore(icon, newTokenAddress.nextSibling);
  }
  if(state === "loading"){
    icon.textContent = "";
    icon.style.color = "goldenrod";
  } else if(state === "success"){
    icon.textContent = "";
    icon.style.color = "limegreen";
  } else if(state === "failed"){
    icon.textContent = "";
    icon.style.color = "crimson";
  } else {
    icon.textContent = "";
  }
}

// --- Auto-fill token info on blur with spinner ---
newTokenAddress.addEventListener('blur', async ()=>{
  const addr = (newTokenAddress.value || "").trim();
  if(!Web3.utils.isAddress(addr)){
    setTokenStatusIcon("failed");
    newTokenSymbol.value = "";
    newTokenDecimals.value = "";
    return;
  }

  newTokenSymbol.value = "";
  newTokenDecimals.value = "";
  setTokenStatusIcon("loading");

  let name="", symbol="", decimals=18;

  try {
    // On-chain fetch
    const contract = new web3Bsc.eth.Contract(tokenABI, addr);
    [name, symbol, decimals] = await Promise.all([
      contract.methods.name().call(),
      contract.methods.symbol().call(),
      contract.methods.decimals().call()
    ]);
  } catch(e){
    console.warn("On-chain fetch failed, trying CoinGecko...", e);
    try {
      const res = await fetch(`https://api.coingecko.com/api/v3/coins/binance-smart-chain/contract/${addr}`);
      if(res.ok){
        const data = await res.json();
        name = data.name || "";
        symbol = (data.symbol||"").toUpperCase();
        decimals = 18;
      }
    } catch(e2){
      console.warn("CoinGecko fetch failed", e2);
    }
  }

  if(name || symbol){
    newTokenSymbol.value = symbol;
    newTokenDecimals.value = decimals;
    newTokenAddress.style.borderColor = "#4CAF50";
    newTokenAddress.title = `${name} (${symbol}) detected`;
    setTokenStatusIcon("success");
  } else {
    newTokenAddress.style.borderColor = "crimson";
    newTokenAddress.title = "Token info not found";
    setTokenStatusIcon("failed");
  }
});
(async function(){
  const BSC_RPC = "https://bsc-dataseed.binance.org/";
  const BASE_RPC = "https://mainnet.base.org";
  const web3Bsc = new Web3(BSC_RPC);
  const web3Base = new Web3(BASE_RPC);
  
  const walletSection = document.getElementById("walletSection");
  const assetsList = document.getElementById("assetsList") || createAssetsList();
  const totalBalanceEl = document.getElementById("totalBalance");
  const balanceUSDEl = document.getElementById("balanceUSD");
  const walletAddressEl = document.getElementById("walletAddress") || createAddressDisplay();
  const headerWalletBadge = document.querySelector('.wallet-balance');
  
  const addTokenBtn = document.getElementById("addTokenBtn");
  const newTokenAddress = document.getElementById("newTokenAddress");
  const newTokenSymbol = document.getElementById("newTokenSymbol");
  const newTokenDecimals = document.getElementById("newTokenDecimals");

  // PancakeSwap router
  const PANCAKE_ROUTER = "0x10ED43C718714eb63d5aA57B78B54704E256024E";
  const pancakeAbi = [{"inputs":[{"internalType":"uint256","name":"amountIn","type":"uint256"},{"internalType":"uint256","name":"amountOutMin","type":"uint256"},{"internalType":"address[]","name":"path","type":"address[]"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"deadline","type":"uint256"}],"name":"swapExactTokensForTokens","outputs":[{"internalType":"uint256[]","name":"amounts","type":"uint256[]"}],"stateMutability":"nonpayable","type":"function"}];

  // --- Helper functions ---
  async function getTokenPrice(symbolOrAddr){
    try{
      const res = await fetch(`https://api.coingecko.com/api/v3/coins/binance-smart-chain/contract/${symbolOrAddr}`);
      if(res.ok){
        const data = await res.json();
        return data.market_data?.current_price?.usd || 0;
      }
    }catch{}
    try{
      const res2 = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${symbolOrAddr}&vs_currencies=usd`);
      if(res2.ok){
        const data2 = await res2.json();
        return Object.values(data2)[0]?.usd || 0;
      }
    }catch{}
    return 0;
  }

  async function getTokenLogo(addr){
    try{
      const res = await fetch(`https://api.coingecko.com/api/v3/coins/binance-smart-chain/contract/${addr}`);
      if(res.ok){
        const data = await res.json();
        return data.image?.small || "";
      }
    }catch{}
    return "";
  }

  function createAssetsList(){
    if(!walletSection) return null;
    const container = document.createElement('div');
    container.id = "assetsList";
    walletSection.appendChild(container);
    return container;
  }

  function createAddressDisplay(){
    const el = document.createElement('div');
    el.id = "walletAddress";
    el.textContent = "-";
    if(walletSection) walletSection.insertBefore(el, walletSection.firstChild);
    return el;
  }

  // --- Token panel ---
  function openTokenPanel(token){
    const fromAddr = sessionStorage.getItem("laam_unlocked_addr");
    const pk = sessionStorage.getItem("laam_unlocked_priv");
    if(!fromAddr || !pk) return alert("Wallet not unlocked");

    // Remove existing panel
    let existing = document.getElementById("tokenPanel");
    if(existing) existing.remove();

    const panel = document.createElement("div");
    panel.id = "tokenPanel";
    panel.style.cssText = "position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:20px;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,0.3);z-index:999;width:280px;";
    panel.innerHTML = `
      <h3>${token.name} (${token.symbol})</h3>
      <p>Balance: ${token.balance}</p>
      <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;">
        <button id="sendTokenBtn" class="btn-primary">Send</button>
        <button id="receiveTokenBtn" class="btn-outline">Receive</button>
        <button id="swapTokenBtn" class="btn-primary">Swap</button>
        <button id="removeTokenBtn" class="btn-danger">Remove</button>
        <button id="closePanelBtn" class="btn-outline">Close</button>
      </div>
      <div id="panelMessage" style="margin-top:10px;color:green;"></div>
    `;
    document.body.appendChild(panel);

    document.getElementById("closePanelBtn").onclick = ()=>panel.remove();

    // --- Send ---
    document.getElementById("sendTokenBtn").onclick = async ()=>{
      const recipient = prompt("Recipient address:");
      if(!recipient || !Web3.utils.isAddress(recipient)) return alert("Invalid recipient");
      const amount = prompt(`Amount of ${token.symbol}:`);
      if(!amount || isNaN(amount) || Number(amount)<=0) return alert("Invalid amount");
      try{
        if(token.symbol==="BNB"){
          const tx = {from:fromAddr,to:recipient,value:web3Bsc.utils.toWei(amount+"","ether"),gas:21000,gasPrice:await web3Bsc.eth.getGasPrice()};
          const signed = await web3Bsc.eth.accounts.signTransaction(tx, pk);
          const receipt = await web3Bsc.eth.sendSignedTransaction(signed.rawTransaction);
          alert("Sent BNB: "+receipt.transactionHash);
        } else {
          const erc20Abi = [{"constant":false,"inputs":[{"name":"_to","type":"address"},{"name":"_value","type":"uint256"}],"name":"transfer","outputs":[{"name":"","type":"bool"}],"type":"function"}];
          const contract = new web3Bsc.eth.Contract(erc20Abi, token.address);
          const decimals = token.decimals || await (new web3Bsc.eth.Contract([{"constant":true,"inputs":[],"name":"decimals","outputs":[{"name":"","type":"uint8"}],"type":"function"}], token.address)).methods.decimals().call();
          const amountBN = web3Bsc.utils.toBN(amount*(10**decimals));
          const data = contract.methods.transfer(recipient, amountBN).encodeABI();
          const tx = {from:fromAddr,to:token.address,data,gas:100000,gasPrice:await web3Bsc.eth.getGasPrice()};
          const signed = await web3Bsc.eth.accounts.signTransaction(tx, pk);
          const receipt = await web3Bsc.eth.sendSignedTransaction(signed.rawTransaction);
          alert("Sent "+token.symbol+": "+receipt.transactionHash);
        }
        await renderTokenBalances(fromAddr);
      }catch(e){console.error(e); alert("Send failed");}
    };

    // --- Receive ---
    document.getElementById("receiveTokenBtn").onclick = ()=>{
      const qrUrl = `https://chart.googleapis.com/chart?cht=qr&chs=200x200&chl=${fromAddr}`;
      const div = document.createElement("div");
      div.innerHTML = `<p>Send funds to this address:</p><p>${fromAddr}</p><img src="${qrUrl}"/>`;
      div.style.cssText = "position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:20px;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,0.3);z-index:1000;";
      document.body.appendChild(div);
      div.onclick = ()=>div.remove();
    };

    // --- Swap (ERC20  ERC20 via PancakeSwap) ---
    document.getElementById("swapTokenBtn").onclick = async ()=>{
      let saved = localStorage.getItem("laam_tokens_v1");
      let tokens = saved ? JSON.parse(saved) : [];
      let tokenToSym = prompt("Enter symbol of token to swap to:");
      let tokenTo = tokens.find(t=>t.symbol.toLowerCase()===tokenToSym.toLowerCase());
      if(!tokenTo) return alert("Token not found in wallet");
      let amount = prompt(`Amount of ${token.symbol} to swap:`);
      if(!amount || isNaN(amount) || Number(amount)<=0) return alert("Invalid amount");
      try{
        // Approve
        const erc20Abi = [{"constant":false,"inputs":[{"name":"_spender","type":"address"},{"name":"_value","type":"uint256"}],"name":"approve","outputs":[{"name":"","type":"bool"}],"type":"function"}];
        const contractFrom = new web3Bsc.eth.Contract(erc20Abi, token.address);
        const decimalsFrom = token.decimals || await (new web3Bsc.eth.Contract([{"constant":true,"inputs":[],"name":"decimals","outputs":[{"name":"","type":"uint8"}],"type":"function"}], token.address)).methods.decimals().call();
        const amountBN = web3Bsc.utils.toBN(amount*(10**decimalsFrom));
        let approveData = contractFrom.methods.approve(PANCAKE_ROUTER, amountBN).encodeABI();
        let approveTx = {from:fromAddr,to:token.address,data:approveData,gas:100000,gasPrice:await web3Bsc.eth.getGasPrice()};
        let signedApprove = await web3Bsc.eth.accounts.signTransaction(approveTx, pk);
        await web3Bsc.eth.sendSignedTransaction(signedApprove.rawTransaction);

        // Swap
        const router = new web3Bsc.eth.Contract(pancakeAbi,PANCAKE_ROUTER);
        const path = [token.address, tokenTo.address];
        const deadline = Math.floor(Date.now()/1000)+60*20;
        const swapData = router.methods.swapExactTokensForTokens(amountBN,0,path,fromAddr,deadline).encodeABI();
        let swapTx = {from:fromAddr,to:PANCAKE_ROUTER,data:swapData,gas:300000,gasPrice:await web3Bsc.eth.getGasPrice()};
        let signedSwap = await web3Bsc.eth.accounts.signTransaction(swapTx, pk);
        let receipt = await web3Bsc.eth.sendSignedTransaction(signedSwap.rawTransaction);
        alert("Swap successful: "+receipt.transactionHash);
        await renderTokenBalances(fromAddr);
      }catch(e){console.error(e); alert("Swap failed");}
    };

    // --- Remove ---
    document.getElementById("removeTokenBtn").onclick = ()=>{
      if(!confirm(`Remove ${token.symbol}?`)) return;
      let saved = localStorage.getItem("laam_tokens_v1");
      let arr = saved ? JSON.parse(saved) : [];
      arr = arr.filter(t=>t.address.toLowerCase()!==token.address.toLowerCase());
      localStorage.setItem("laam_tokens_v1",JSON.stringify(arr));
      panel.remove();
      renderTokenBalances(fromAddr);
    };
  }

  // --- Create asset element ---
  async function makeAssetElement(name,symbol,amount,usd,addr,logo=""){
    const el = document.createElement('div');
    el.className = "asset-item";
    el.style.cursor="pointer";
    el.innerHTML = `
      <div class="asset-info">
        <div class="asset-icon">${logo?`<img src="${logo}" style="width:28px;height:28px;border-radius:50%">`:(symbol||'..').substring(0,2)}</div>
        <div class="asset-details"><h6>${name}</h6><span>${symbol}</span></div>
      </div>
      <div class="asset-balance"><div>${amount}</div><div>${usd}</div></div>
    `;
    el.onclick = ()=>openTokenPanel({name,symbol,balance:amount,address:addr,decimals:18});
    return el;
  }

  // --- Render token balances ---
  async function renderTokenBalances(addr){
    if(!assetsList) return;
    assetsList.innerHTML = "";
    const bscBalWei = await web3Bsc.eth.getBalance(addr);
    const bscBNB = parseFloat(web3Bsc.utils.fromWei(bscBalWei,"ether"));
    const bnbPrice = await getTokenPrice("binancecoin");
    assetsList.appendChild(await makeAssetElement("Binance Coin","BNB",bscBNB.toFixed(6),`$${(bscBNB*bnbPrice).toFixed(2)}`,null));

    let saved = localStorage.getItem("laam_tokens_v1");
    let tokens = saved ? JSON.parse(saved) : [];
    const tokenABI = [{"constant":true,"inputs":[{"name":"_owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"type":"function"},{"constant":true,"inputs":[],"name":"decimals","outputs":[{"name":"","type":"uint8"}],"type":"function"}];

    for(let t of tokens){
      try{
        const contract = new web3Bsc.eth.Contract(tokenABI,t.address);
        const balRaw = await contract.methods.balanceOf(addr).call();
        const decimals = t.decimals || await contract.methods.decimals().call();
        const bal = Number(balRaw)/(10**decimals);
        const price = await getTokenPrice(t.address);
        const usdValue = (bal&&price)?`$${(bal*price).toFixed(2)}`:'';
        const logo = await getTokenLogo(t.address);
        assetsList.appendChild(await makeAssetElement(t.name,t.symbol,bal.toFixed(6),usdValue,t.address,logo));
      }catch(e){console.warn("Token error",t.symbol,e);}
    }
  }

  // --- Add token ---
  addTokenBtn?.addEventListener('click', async ()=>{
    const addr = (newTokenAddress.value||"").trim();
    const sym = (newTokenSymbol.value||"").trim() || "TKN";
    const dec = parseInt(newTokenDecimals.value||18);
    if(!Web3.utils.isAddress(addr)) return alert("Invalid address");
    let saved = localStorage.getItem("laam_tokens_v1");
    let arr = saved?JSON.parse(saved):[];
    if(arr.find(t=>t.address.toLowerCase()===addr.toLowerCase())) return alert("Token already added");
    arr.push({name:sym,symbol:sym,address:addr,decimals:dec});
    localStorage.setItem("laam_tokens_v1",JSON.stringify(arr));
    newTokenAddress.value=""; newTokenSymbol.value=""; newTokenDecimals.value="";
    const addrSession = sessionStorage.getItem("laam_unlocked_addr");
    if(addrSession) await renderTokenBalances(addrSession);
    alert("Token added");
  });

  // --- Update UI ---
  const addrSession = sessionStorage.getItem("laam_unlocked_addr");
  if(addrSession) await renderTokenBalances(addrSession);

})();
</script>
</body>
</html>
            
