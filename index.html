<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LaamSocial - Upload & Feed</title>
<style>
  body { font-family: Arial, sans-serif; margin:0; background:#f4f4f4; }
  .auth-container, .dashboard { max-width:400px; margin:40px auto; background:#fff; padding:20px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
  h2,h3 { text-align:center; color:#333; }
  input, textarea, select { width:100%; padding:10px; margin:5px 0; border:1px solid #ccc; border-radius:6px; }
  button { width:100%; padding:10px; background:#0066ff; color:#fff; border:none; border-radius:6px; cursor:pointer; }
  button:hover { background:#004ccc; }
  #feed img, #feed video { width:100%; border-radius:8px; margin-top:5px; }
  .post { background:#fff; padding:10px; border-radius:8px; margin-bottom:15px; box-shadow:0 2px 4px rgba(0,0,0,0.1);}
  .hidden { display:none; }
</style>
</head>
<body>

<div class="auth-container" id="authSection">
  <h2>LaamSocial</h2>

  <!-- Register Form -->
  <div id="registerForm">
    <h3>Register</h3>
    <input type="text" id="regFullName" placeholder="Full Name">
    <input type="text" id="regUsername" placeholder="Username">
    <input type="email" id="regEmail" placeholder="Email">
    <input type="password" id="regPassword" placeholder="Password">
    <button id="registerBtn">Register</button>
    <p>Already have an account? <span id="showLogin" style="color:blue;cursor:pointer;">Login</span></p>
  </div>

  <!-- Login Form -->
  <div id="loginForm" class="hidden">
    <h3>Login</h3>
    <input type="email" id="loginEmail" placeholder="Email">
    <input type="password" id="loginPassword" placeholder="Password">
    <button id="loginBtn">Login</button>
    <p>Don't have an account? <span id="showRegister" style="color:blue;cursor:pointer;">Register</span></p>
  </div>
</div>

<div class="dashboard hidden" id="dashboard">
  <h2>LaamSocial Feed</h2>
  <p>Welcome, <strong id="userNameDisplay"></strong></p>
  <button id="logoutBtn">Logout</button>

  <h3>Create Post</h3>
  <textarea id="postText" placeholder="What's on your mind?"></textarea>
  <input type="file" id="postFile" accept="image/*,video/*">
  <button id="postBtn">Post</button>

  <h3>Feed</h3>
  <div id="feed">Loading...</div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
  import { getFirestore, collection, addDoc, getDocs, orderBy, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyDy_GTVZvwCZp8eLYvd_TUPI-uo_Jp5MpY",
    authDomain: "laamsocial-98cce.firebaseapp.com",
    projectId: "laamsocial-98cce",
    storageBucket: "laamsocial-98cce.appspot.com",
    messagingSenderId: "649707204234",
    appId: "1:649707204234:web:2f22441b4dbbacc5674773"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Elements
  const authSection = document.getElementById("authSection");
  const dashboard = document.getElementById("dashboard");
  const registerForm = document.getElementById("registerForm");
  const loginForm = document.getElementById("loginForm");
  const showLogin = document.getElementById("showLogin");
  const showRegister = document.getElementById("showRegister");
  const registerBtn = document.getElementById("registerBtn");
  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const userNameDisplay = document.getElementById("userNameDisplay");
  const postBtn = document.getElementById("postBtn");
  const postText = document.getElementById("postText");
  const postFile = document.getElementById("postFile");
  const feed = document.getElementById("feed");

  // Toggle forms
  showLogin.onclick = ()=>{ registerForm.classList.add("hidden"); loginForm.classList.remove("hidden"); }
  showRegister.onclick = ()=>{ loginForm.classList.add("hidden"); registerForm.classList.remove("hidden"); }

  // Register
  registerBtn.onclick = async ()=>{
    const fullName = document.getElementById("regFullName").value.trim();
    const username = document.getElementById("regUsername").value.trim();
    const email = document.getElementById("regEmail").value.trim();
    const password = document.getElementById("regPassword").value.trim();

    if(!fullName || !username || !email || !password) return alert("Fill all fields");

    try{
      const cred = await createUserWithEmailAndPassword(auth, email, password);
      await addDoc(collection(db,"users"), { uid: cred.user.uid, fullName, username, email });
      alert("Registered successfully!");
    }catch(err){ alert(err.message); }
  }

  // Login
  loginBtn.onclick = async ()=>{
    const email = document.getElementById("loginEmail").value.trim();
    const password = document.getElementById("loginPassword").value.trim();
    try{
      await signInWithEmailAndPassword(auth,email,password);
    }catch(err){ alert(err.message); }
  }

  // Auth state
  onAuthStateChanged(auth, user=>{
    if(user){
      authSection.classList.add("hidden");
      dashboard.classList.remove("hidden");
      userNameDisplay.textContent = user.email.split("@")[0];
      loadFeed();
    }else{
      dashboard.classList.add("hidden");
      authSection.classList.remove("hidden");
    }
  });

  // Logout
  logoutBtn.onclick = ()=>signOut(auth);

  // Upload to Cloudinary
  async function uploadToCloudinary(file){
    const formData = new FormData();
    formData.append("file", file);
    formData.append("upload_preset", "laamsocial_upload");
    const res = await fetch("https://api.cloudinary.com/v1_1/dwbcovoit/upload", {
      method: "POST",
      body: formData
    });
    const data = await res.json();
    return data.secure_url;
  }

  // Post
  postBtn.onclick = async ()=>{
    const text = postText.value.trim();
    const file = postFile.files[0];
    let mediaUrl = "";

    if(!text && !file){ alert("Write something or choose a file"); return; }

    if(file){ 
      mediaUrl = await uploadToCloudinary(file); 
    }

    await addDoc(collection(db,"posts"),{
      text, media: mediaUrl, createdAt: serverTimestamp()
    });

    postText.value="";
    postFile.value="";
    loadFeed();
  }

  // Load feed
  async function loadFeed(){
    const q = query(collection(db,"posts"), orderBy("createdAt","desc"));
    const snap = await getDocs(q);
    feed.innerHTML="";
    snap.forEach(doc=>{
      const post = doc.data();
      const div = document.createElement("div");
      div.className="post";
      let html = `<p>${post.text || ""}</p>`;
      if(post.media){
        if(post.media.includes(".mp4")) html += `<video src="${post.media}" controls></video>`;
        else html += `<img src="${post.media}" alt="post media">`;
      }
      div.innerHTML = html;
      feed.appendChild(div);
    });
  }
</script>
</body>
</html>
